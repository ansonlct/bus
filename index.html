<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Â∑¥Â£´Áè≠Ê¨°">
    
    <!-- Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%23E3001B' rx='120'/%3E%3Ctext x='50%25' y='50%25' font-size='280' text-anchor='middle' dy='.35em' dominant-baseline='middle' fill='white'%3EKMB%3C/text%3E%3C/svg%3E">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüöå%3C/text%3E%3C/svg%3E">

    <title>‰πùÂ∑¥Áè≠Ê¨°Êü•Ë©¢</title>
    <style>
        :root {
            --bg-color: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-main: #1C1C1E;
            --text-sub: #8E8E93;
            --kmb-red: #E3001B;
            --accent: #007AFF;
            --separator: #E5E5EA;
            --sidebar-width: 280px;
        }

        body.dark-mode {
            --bg-color: #000000;
            --card-bg: #1C1C1E;
            --text-main: #FFFFFF;
            --text-sub: #98989D;
            --separator: #38383A;
        }

        * { -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        select, input, textarea { -webkit-user-select: auto; user-select: auto; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: env(safe-area-inset-top) 0 0 0;
            color: var(--text-main);
            height: 100dvh; display: flex; flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden;
        }

        .container { flex: 1; display: flex; flex-direction: column; width: 100%; max-width: 600px; margin: 0 auto; overflow: hidden; position: relative; z-index: 1; }

        /* --- È†ÇÈÉ®Â∞éËà™ÂçÄ --- */
        .search-area {
            padding: 12px 16px;
            background: var(--bg-color);
            display: flex; gap: 8px;
            z-index: 200;
            box-shadow: 0 1px 0 rgba(0,0,0,0.05);
            align-items: center;
        }

        .menu-btn {
            font-size: 1.5rem; padding: 4px 8px; cursor: pointer; color: var(--text-main);
        }

        .search-wrapper { position: relative; flex: 1; }

        .search-input {
            width: 100%; padding: 10px 32px 10px 14px;
            border-radius: 12px; border: none;
            background: var(--card-bg); color: var(--text-main); font-size: 1.1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); outline: none;
        }
        
        .clear-input-btn {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            width: 20px; height: 20px; border-radius: 50%;
            background: rgba(142, 142, 147, 0.3); color: white;
            font-size: 12px; display: none;
            align-items: center; justify-content: center; cursor: pointer;
        }
        .clear-input-btn:active { background: rgba(142, 142, 147, 0.8); }

        .suggestions-list {
            position: absolute; top: 110%; left: 0; right: 0;
            background: var(--card-bg); border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            max-height: 0; overflow-y: auto; overflow-x: hidden;
            transition: max-height 0.2s ease-out; z-index: 1000;
        }
        .suggestions-list.show { max-height: 300px; border: 1px solid rgba(0,0,0,0.05); }

        .suggestion-item {
            padding: 12px 16px; border-bottom: 1px solid var(--separator);
            font-size: 1.05rem; color: var(--text-main); cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .suggestion-item:active { background: rgba(0,0,0,0.05); }
        .suggestion-item:last-child { border-bottom: none; }
        
        .sug-route { font-weight: 700; color: var(--kmb-red); font-size: 1.1rem; width: 60px; }
        .sug-desc { font-size: 0.8rem; color: var(--text-sub); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: right; }

        .search-btn {
            padding: 0 16px; background: var(--kmb-red); color: white;
            border: none; border-radius: 12px; font-weight: 600; font-size: 1rem;
            cursor: pointer; box-shadow: 0 2px 8px rgba(227, 0, 27, 0.3);
            transition: opacity 0.2s; white-space: nowrap; height: 42px;
        }
        .search-btn:active { transform: scale(0.96); opacity: 0.9; }
        .search-btn:disabled { background: var(--text-sub); cursor: not-allowed; box-shadow: none; }

        .clear-all-btn {
            width: 42px; height: 42px; background: #8E8E93; color: white;
            border: none; border-radius: 12px; font-size: 1.2rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: opacity 0.2s;
        }
        .clear-all-btn:active { opacity: 0.8; transform: scale(0.96); }

        .content-scroll { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 10px 16px; scroll-behavior: smooth; }

        /* --- Âç°ÁâáÊ®£Âºè --- */
        .card {
            background: var(--card-bg); border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05); margin-bottom: 20px;
            position: relative;
            animation: slideIn 0.3s ease-out;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card.dragging {
            opacity: 0.5; background: #f8f8f8; box-shadow: 0 10px 20px rgba(0,0,0,0.2); z-index: 100;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card-header {
            background: linear-gradient(135deg, #E3001B, #C20017);
            padding: 12px 16px; color: white;
            display: flex; flex-direction: column; gap: 8px;
            position: relative; padding-left: 40px;
        }

        .drag-handle {
            position: absolute; top: 12px; left: 10px; width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; color: rgba(255, 255, 255, 0.6); cursor: grab; z-index: 15;
            touch-action: none;
        }
        
        .card-actions {
            position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 10;
        }
        
        .close-card-btn {
            position: absolute; top: 10px; right: 10px;
            width: 28px; height: 28px;
            background: rgba(0, 0, 0, 0.2); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: white; font-weight: bold; font-size: 14px;
            backdrop-filter: blur(4px); transition: background 0.2s; z-index: 10;
        }
        .close-card-btn:active { background: rgba(0, 0, 0, 0.4); }

        .header-top { display: flex; align-items: center; padding-right: 40px; }
        .icon { font-size: 1.4rem; margin-right: 8px; }
        .card-title { font-size: 1.3rem; font-weight: 800; }
        
        .direction-switch {
            display: flex; background: rgba(0, 0, 0, 0.2);
            padding: 3px; border-radius: 8px; margin-top: 4px;
        }
        
        .dir-opt {
            flex: 1; text-align: center;
            font-size: 0.85rem; color: rgba(255, 255, 255, 0.7);
            padding: 6px 4px; border-radius: 6px;
            cursor: pointer; transition: all 0.2s; font-weight: 500;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .dir-opt.active {
            background: white; color: var(--kmb-red); font-weight: 700; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .card-content { padding: 4px 16px 16px; min-height: 50px; }

        .schedule-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 0; border-bottom: 1px dashed var(--separator);
            cursor: pointer; overflow: hidden;
            max-height: 100px; opacity: 1;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.3s ease-in-out, padding 0.4s ease, margin 0.4s ease, border-bottom-width 0.4s ease;
        }
        .schedule-item:active { background-color: rgba(0,0,0,0.03); }
        .schedule-item:last-child { border-bottom: none; }
        .schedule-item.no-border { border-bottom: none !important; }
        .schedule-item.hidden-row {
            max-height: 0; opacity: 0; padding-top: 0; padding-bottom: 0; margin: 0; border-bottom-width: 0; pointer-events: none;
        }

        .stop-info { flex: 1; display: flex; align-items: center; overflow: hidden; padding-right: 10px; }
        .dest-name { font-size: 1.05rem; font-weight: 600; color: var(--text-main); }
        .dest-seq { 
            color: var(--text-sub); font-size: 0.8rem; margin-right: 10px; font-weight: 400; 
            display: inline-block; width: 30px; text-align: center;
            cursor: pointer; flex-shrink: 0; user-select: none; transition: transform 0.2s; 
        }
        .eta-time { font-size: 0.85rem; color: var(--text-sub); display: block; text-align: right; margin-bottom: 2px;}
        .eta-minutes {
            font-size: 1rem; color: #34C759; font-weight: 700;
            background: #E8F5E9; padding: 4px 8px; border-radius: 6px;
            display: inline-block; min-width: 45px; text-align: center; transition: all 0.2s;
        }
        body.dark-mode .eta-minutes { background: rgba(52, 199, 89, 0.2); color: #32D74B; }
        .urgent { color: #FF3B30 !important; background: #FFEBEE !important; }
        body.dark-mode .urgent { background: rgba(255, 69, 58, 0.2) !important; color: #FF453A !important; }
        .eta-minutes.show-real-time {
            font-family: "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
            font-weight: 600; background: var(--bg-color); color: var(--text-main);
            border: 1px solid rgba(0,0,0,0.1);
        }

        .status-msg { text-align: center; padding: 40px 20px; color: var(--text-sub); }
        .fading { opacity: 0.5; pointer-events: none; }
        #empty-state { text-align: center; padding: 60px 20px; color: var(--text-sub); display: flex; flex-direction: column; align-items: center; }
        #empty-state .big-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.3; }

        /* --- ÂÅ¥ÈÇäÊ¨Ñ Sidebar --- */
        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; opacity: 0; visibility: hidden;
            transition: all 0.3s; backdrop-filter: blur(2px);
        }
        .sidebar-overlay.active { opacity: 1; visibility: visible; }

        .sidebar {
            position: fixed; top: 0; left: -100%; width: 85%; max-width: 320px; height: 100%;
            background: var(--card-bg); z-index: 1001; transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column; box-shadow: 2px 0 12px rgba(0,0,0,0.1);
        }
        .sidebar.active { left: 0; }

        .sidebar-header {
            padding: 20px 16px; border-bottom: 1px solid var(--separator);
            display: flex; justify-content: space-between; align-items: center;
        }
        .sidebar-title { font-size: 1.2rem; font-weight: 700; color: var(--text-main); }
        
        .sidebar-content { flex: 1; overflow-y: auto; padding: 10px 0; }

        /* ÂÅ¥ÈÇäÊ¨ÑË®≠ÂÆö */
        .sidebar-settings {
            padding: 15px 16px;
            border-bottom: 1px solid var(--separator);
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.02);
        }
        .setting-label { font-size: 1rem; color: var(--text-main); font-weight: 600; }
        
        .ios-switch {
            position: relative; display: inline-block; width: 51px; height: 31px;
        }
        .ios-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #E9E9EA; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 27px; width: 27px;
            left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input:checked + .slider { background-color: #34C759; }
        input:checked + .slider:before { transform: translateX(20px); }
        body.dark-mode .slider { background-color: #39393D; }

        .saved-item {
            padding: 12px 16px; border-bottom: 1px solid var(--separator);
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; background: var(--card-bg); transition: background 0.2s;
            position: relative;
        }
        .saved-item:active { background: rgba(0,0,0,0.05); }
        .saved-item.dragging { opacity: 0.5; background: #e0e0e0; }

        .saved-drag-handle {
            color: var(--text-sub); margin-right: 12px; font-size: 1.1rem; cursor: grab;
            display: none; 
        }
        .delete-btn {
            padding: 8px; color: #FF3B30; opacity: 0.8; transition: opacity 0.2s; z-index: 2;
            display: none; 
        }

        .sidebar-content.editing .saved-drag-handle { display: block; }
        .sidebar-content.editing .delete-btn { display: block; }
        .sidebar-content.editing .saved-item { padding-left: 10px; } 
        .sidebar-content.editing .saved-info { pointer-events: auto; }

        .saved-info { flex: 1; pointer-events: none; }
        .saved-name { font-size: 1rem; font-weight: 600; color: var(--text-main); display: flex; align-items: center; gap: 6px;}
        .saved-detail { font-size: 0.8rem; color: var(--text-sub); margin-top: 2px; }
        
        .default-badge {
            font-size: 0.65rem; color: white; background: #34C759; padding: 2px 6px;
            border-radius: 4px; font-weight: 700; text-transform: uppercase;
        }

        .sidebar-footer {
            padding: 16px; border-top: 1px solid var(--separator);
            display: flex; gap: 10px;
        }
        
        .save-all-btn {
            flex: 1; padding: 12px; background: var(--accent); color: white;
            border: none; border-radius: 12px; font-weight: 600; font-size: 1rem; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .save-all-btn:active { opacity: 0.9; }

        .edit-mode-btn {
            width: 48px; height: 48px; flex-shrink: 0;
            background: #F2F2F7; color: var(--text-main);
            border: none; border-radius: 12px; font-size: 1.2rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        body.dark-mode .edit-mode-btn { background: #2C2C2E; }
        .edit-mode-btn.active { background: var(--kmb-red); color: white; }

    </style>
</head>
<body>

<div class="sidebar-overlay" id="overlay" onclick="toggleSidebar(false)"></div>
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <span class="sidebar-title">Â∑≤ÂÑ≤Â≠òÈ†ÖÁõÆ</span>
        <span onclick="toggleSidebar(false)" style="cursor:pointer; padding:5px; font-size:1.2rem;">‚úï</span>
    </div>
    
    <div class="sidebar-settings">
        <span class="setting-label">ÈªëÊöóÊ®°Âºè</span>
        <label class="ios-switch">
            <input type="checkbox" id="dm-toggle" onchange="toggleDarkMode()">
            <span class="slider"></span>
        </label>
    </div>

    <div class="sidebar-content" id="saved-list-container"></div>

    <div class="sidebar-footer">
        <button class="save-all-btn" onclick="saveCurrentAsGroup()">Ôºã ÂÑ≤Â≠òÁï∂ÂâçÁâàÈù¢</button>
        <button class="edit-mode-btn" id="edit-btn" onclick="toggleEditMode()">‚úé</button>
    </div>
</div>

<div class="container">
    <div class="search-area">
        <div class="menu-btn" onclick="toggleSidebar(true)">‚ò∞</div>
        <div class="search-wrapper">
            <input type="text" id="route-input" class="search-input" 
                   placeholder="Ëº∏ÂÖ•Ë∑ØÁ∑ö (Â¶Ç 900)" value="" 
                   autocomplete="off"
                   oninput="handleInput()" 
                   onfocus="handleInput()"
                   onkeypress="if(event.key==='Enter') searchRoute()">
            
            <div id="clear-search" class="clear-input-btn" onclick="clearSearch()">‚úï</div>
            <div id="suggestions" class="suggestions-list"></div>
        </div>
        
        <button id="search-btn" class="search-btn" onclick="searchRoute()">Êü•Ë©¢</button>
        <button class="clear-all-btn" onclick="clearAllCards()" title="Ê∏ÖÈô§ÊâÄÊúâ">üóë</button>
    </div>

    <div class="content-scroll" id="cards-container">
        <div id="empty-state">
            <div class="big-icon">üöç</div>
            <div>Ë´ãËº∏ÂÖ•Ë∑ØÁ∑öËôüÁ¢ºÈñãÂßãÊü•Ë©¢</div>
        </div>
    </div>
        
    <div style="text-align:center; font-size:0.7rem; color:var(--text-sub); margin-top:10px; padding-bottom: 20px;">
        Ë≥áÊñô‰æÜÊ∫êÔºöDATA.GOV.HK<br>Designed by AI
    </div>
</div>

<script>
    let kmbStopCache = {};
    let allRoutesDB = []; 
    let validRouteSet = new Set();
    window.cardRegistry = {};
    let cardCounter = 0;
    let isEditMode = false;

    document.addEventListener('DOMContentLoaded', () => {
        initDarkMode();
        preloadAllRoutes(); 
        StorageManager.loadAll(); 
        
        const savedList = StorageManager.getList();
        if (savedList.length > 0) {
            loadSavedItem(savedList[0].id);
        }

        document.addEventListener('click', (e) => {
            const wrapper = document.querySelector('.search-wrapper');
            if (!wrapper.contains(e.target)) { hideSuggestions(); }
        });

        const container = document.getElementById('cards-container');
        container.addEventListener('dragover', e => {
            e.preventDefault(); 
            if (!document.querySelector('.card.dragging')) return;
            const afterElement = getDragAfterElement(container, e.clientY, '.card');
            const draggable = document.querySelector('.card.dragging');
            if (draggable) {
                if (afterElement == null) container.appendChild(draggable);
                else container.insertBefore(draggable, afterElement);
            }
        });

        const sidebarList = document.getElementById('saved-list-container');
        sidebarList.addEventListener('dragover', e => {
            e.preventDefault();
            if (!isEditMode) return;
            if (!document.querySelector('.saved-item.dragging')) return;

            const afterElement = getDragAfterElement(sidebarList, e.clientY, '.saved-item');
            const draggable = document.querySelector('.saved-item.dragging');
            if (draggable) {
                if (afterElement == null) sidebarList.appendChild(draggable);
                else sidebarList.insertBefore(draggable, afterElement);
            }
        });
    });

    // ==========================================================
    //  Storage Manager (with Temp List for Edit Mode)
    // ==========================================================
    const StorageManager = {
        key: 'kmb_saved_list',
        tempList: null, // Êö´Â≠òÂàóË°®
        
        getList: () => {
            if (isEditMode && StorageManager.tempList !== null) {
                return StorageManager.tempList;
            }
            return JSON.parse(localStorage.getItem(StorageManager.key) || '[]');
        },

        saveItem: (name, cardsData) => {
            // Êñ∞Â¢ûÈ†ÖÁõÆÊôÇÁõ¥Êé•ÂØ´ÂÖ• localStorage (‰∏çËµ∞ temp)
            let list = JSON.parse(localStorage.getItem(StorageManager.key) || '[]');
            list.push({ id: Date.now(), name: name, data: cardsData });
            localStorage.setItem(StorageManager.key, JSON.stringify(list));
            
            // Â¶ÇÊûúÂú®Á∑®ËºØÊ®°Âºè‰∏ãÊñ∞Â¢ûÔºåÈúÄË¶ÅÊõ¥Êñ∞ temp ÈÅøÂÖçË°ùÁ™ÅÔºå‰ΩÜÁ∞°ÂñÆËµ∑Ë¶ãÔºåÊàëÂÄëÂÅáË®≠Êñ∞Â¢ûÊúÉÁõ¥Êé•Êõ¥Êñ∞Áï´Èù¢
            if (isEditMode) {
                 StorageManager.tempList = list;
            }
            StorageManager.renderList();
        },

        // Âà™Èô§ (Êìç‰Ωú Temp Êàñ Real)
        deleteItem: (id) => {
            if (isEditMode) {
                StorageManager.tempList = StorageManager.tempList.filter(item => item.id !== id);
            } else {
                let list = StorageManager.getList();
                list = list.filter(item => item.id !== id);
                localStorage.setItem(StorageManager.key, JSON.stringify(list));
            }
            StorageManager.renderList();
        },
        
        renameItem: (id) => {
            if (!isEditMode) return;
            const item = StorageManager.tempList.find(x => x.id === id);
            if (!item) return;
            
            const newName = prompt("Ë´ãËº∏ÂÖ•Êñ∞ÂêçÁ®±:", item.name);
            if (newName && newName.trim() !== "") {
                item.name = newName.trim();
                StorageManager.renderList();
            }
        },

        // Êõ¥Êñ∞È†ÜÂ∫è (Êõ¥Êñ∞Âà∞ Temp)
        updateOrderFromDOM: () => {
            if (!isEditMode) return;
            
            const container = document.getElementById('saved-list-container');
            const items = container.querySelectorAll('.saved-item');
            const oldList = StorageManager.tempList;
            const newList = [];

            items.forEach(el => {
                const id = parseInt(el.getAttribute('data-id'));
                const data = oldList.find(x => x.id === id);
                if (data) newList.push(data);
            });
            StorageManager.tempList = newList;
            StorageManager.renderList(); 
        },

        // Ê≠£ÂºèÊèê‰∫§ Temp Âà∞ LocalStorage
        commitChanges: () => {
            if (StorageManager.tempList !== null) {
                localStorage.setItem(StorageManager.key, JSON.stringify(StorageManager.tempList));
                StorageManager.tempList = null;
            }
        },

        // Êç®Ê£Ñ Temp (ÈÇÑÂéü)
        discardChanges: () => {
            StorageManager.tempList = null;
        },

        // ÂàùÂßãÂåñ Temp
        initTemp: () => {
             StorageManager.tempList = JSON.parse(localStorage.getItem(StorageManager.key) || '[]');
        },

        loadAll: () => {
            StorageManager.renderList();
        },

        renderList: () => {
            const list = StorageManager.getList();
            const container = document.getElementById('saved-list-container');
            
            if (list.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-sub);">Êö´ÁÑ°ÂÑ≤Â≠òÈ†ÖÁõÆ</div>';
                return;
            }

            container.innerHTML = list.map((item, index) => {
                const isDefault = index === 0;
                let desc = "";
                if (item.data.length > 1) {
                    desc = `${item.data.length} ÂÄãË∑ØÁ∑öÁµÑÂêà`;
                } else {
                    const d = item.data[0];
                    if (d.destName) {
                        desc = `${d.route} ÂæÄ ${d.destName}`;
                    } else {
                        desc = `${d.route} ${d.dir==='outbound'?'ÂéªÁ®ã':'ÂõûÁ®ã'}`;
                    }
                }

                return `
                    <div class="saved-item" draggable="${isEditMode}" data-id="${item.id}" onclick="onSavedItemClick(${item.id})">
                        <div class="saved-drag-handle">‚â°</div>
                        <div class="saved-info">
                            <div class="saved-name">
                                ${item.name}
                                ${isDefault ? '<span class="default-badge">È†êË®≠</span>' : ''}
                            </div>
                            <div class="saved-detail">${desc}</div>
                        </div>
                        <div class="delete-btn" onclick="deleteSaved(event, ${item.id})">üóë</div>
                    </div>
                `;
            }).join('');

            if (isEditMode) container.classList.add('editing');
            else container.classList.remove('editing');

            StorageManager.bindDragEvents();
        },

        bindDragEvents: () => {
            const items = document.querySelectorAll('.saved-item');
            items.forEach(item => {
                item.addEventListener('dragstart', () => item.classList.add('dragging'));
                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    if(isEditMode) StorageManager.updateOrderFromDOM(); 
                });
                
                const handle = item.querySelector('.saved-drag-handle');
                handle.addEventListener('touchstart', (e) => { 
                    item.classList.add('dragging'); 
                }, {passive: true});
                handle.addEventListener('touchend', () => {
                     item.classList.remove('dragging');
                     if(isEditMode) StorageManager.updateOrderFromDOM();
                });
                handle.addEventListener('touchmove', (e) => {
                    const container = document.getElementById('saved-list-container');
                    const touchLocation = e.targetTouches[0];
                    const afterElement = getDragAfterElement(container, touchLocation.clientY, '.saved-item');
                    const draggable = document.querySelector('.saved-item.dragging');
                    if (draggable) {
                        if (afterElement == null) container.appendChild(draggable);
                        else container.insertBefore(draggable, afterElement);
                    }
                    e.preventDefault();
                }, {passive: false});
            });
        }
    };

    // ==========================================================
    //  UI Actions
    // ==========================================================
    function toggleSidebar(show) {
        const sb = document.getElementById('sidebar');
        const ov = document.getElementById('overlay');
        
        if (show) { 
            sb.classList.add('active'); ov.classList.add('active'); 
        } else { 
            // ÈóúÈñâÂÅ¥ÈÇäÊ¨ÑÊôÇÔºåËã•Âú®Á∑®ËºØÊ®°ÂºèÔºåÂâáÈÇÑÂéü (‰∏çÂÑ≤Â≠ò)
            if (isEditMode) {
                // Ëá™ÂãïÈÄÄÂá∫Á∑®ËºØÊ®°Âºè‰∏¶ÈÇÑÂéü
                isEditMode = false;
                StorageManager.discardChanges();
                
                // UI ÈÇÑÂéü
                const btn = document.getElementById('edit-btn');
                btn.innerHTML = '‚úé'; 
                btn.classList.remove('active');
                StorageManager.renderList();
            }
            
            sb.classList.remove('active'); ov.classList.remove('active'); 
        }
    }

    function toggleEditMode() {
        isEditMode = !isEditMode;
        const btn = document.getElementById('edit-btn');
        
        if (isEditMode) {
            // ÈÄ≤ÂÖ•Á∑®ËºØÊ®°ÂºèÔºöÂàùÂßãÂåñ Temp
            StorageManager.initTemp();
            btn.innerHTML = 'üíæ'; 
            btn.classList.add('active');
        } else {
            // ÈÄÄÂá∫Á∑®ËºØÊ®°Âºè (Êåâ‰∏ãÂÑ≤Â≠ò)ÔºöÂØ´ÂÖ• DB
            StorageManager.commitChanges();
            btn.innerHTML = '‚úé'; 
            btn.classList.remove('active');
        }
        
        StorageManager.renderList();
    }

    function onSavedItemClick(id) {
        if (isEditMode) {
            StorageManager.renameItem(id);
        } else {
            loadSavedItem(id);
        }
    }

    function saveCurrentAsGroup() {
        const cards = document.querySelectorAll('.card');
        if (cards.length === 0) { alert('ÁõÆÂâçÊ≤íÊúâ‰ªª‰ΩïÂç°ÁâáÂèØÂÑ≤Â≠ò'); return; }
        
        let defaultName = "";
        if (cards.length > 0) {
            const firstCard = window.cardRegistry[cards[0].id];
            defaultName = `‰πùÂ∑¥ ${firstCard.route}`;
            if (firstCard.currentDestName) {
                defaultName += ` ÂæÄ ${firstCard.currentDestName}`;
            }
        }
        if (cards.length > 1) defaultName = 'ÊàëÁöÑÈÄöÂã§ÁµÑÂêà';

        const name = prompt('Ë´ãËº∏ÂÖ•ÂêçÁ®±Ôºö', defaultName);
        if (!name) return;

        const data = [];
        cards.forEach(card => {
            const obj = window.cardRegistry[card.id];
            if (obj) {
                data.push({
                    route: obj.route,
                    dir: obj.dir,
                    destName: obj.currentDestName, 
                    filteredSeq: obj.filteredSeq,
                    markedSeq: obj.markedSeq
                });
            }
        });

        StorageManager.saveItem(name, data);
    }

    function loadSavedItem(id) {
        const list = StorageManager.getList();
        const item = list.find(x => x.id === id);
        if (!item) return;

        clearAllCards(false);
        
        item.data.forEach(d => {
            createCard(d.route, d);
        });
        
        toggleSidebar(false);
    }

    function deleteSaved(e, id) {
        e.stopPropagation();
        if(confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÂóéÔºü')) {
            StorageManager.deleteItem(id);
        }
    }

    function clearAllCards(showEmpty = true) {
        const container = document.getElementById('cards-container');
        container.innerHTML = '';
        window.cardRegistry = {};
        
        if (showEmpty) {
            const emptyState = document.createElement('div');
            emptyState.id = 'empty-state';
            emptyState.innerHTML = '<div class="big-icon">üöç</div><div>Ë´ãËº∏ÂÖ•Ë∑ØÁ∑öËôüÁ¢ºÈñãÂßãÊü•Ë©¢</div>';
            container.appendChild(emptyState);
        }
    }

    // ==========================================================
    //  Input Logic
    // ==========================================================
    function handleInput() {
        const input = document.getElementById('route-input');
        const clearBtn = document.getElementById('clear-search');
        const val = input.value.trim().toUpperCase();
        
        if (input.value.length > 0) {
            clearBtn.style.display = 'flex';
        } else {
            clearBtn.style.display = 'none';
        }

        const btn = document.getElementById('search-btn');
        const list = document.getElementById('suggestions');
        
        if (val && validRouteSet.size > 0 && !validRouteSet.has(val)) {
            btn.disabled = true; btn.innerText = 'ÁÑ°Ê≠§Ë∑ØÁ∑ö'; btn.style.background = 'var(--text-sub)';
        } else {
            btn.disabled = false; btn.innerText = 'Êü•Ë©¢'; btn.style.background = 'var(--kmb-red)';
        }

        if (!val || allRoutesDB.length === 0) { hideSuggestions(); return; }
        const matches = allRoutesDB.filter(r => r.route.startsWith(val)).slice(0, 50); 
        if (matches.length === 0) { hideSuggestions(); return; }

        list.innerHTML = matches.map(r => `
            <div class="suggestion-item" onmousedown="selectSuggestion('${r.route}')">
                <span class="sug-route">${r.route}</span>
                <span class="sug-desc">${r.orig} ‚áÑ ${r.dest}</span>
            </div>
        `).join('');
        list.classList.add('show');
    }

    function clearSearch() {
        const input = document.getElementById('route-input');
        input.value = '';
        handleInput(); 
        input.focus();
    }

    function hideSuggestions() { document.getElementById('suggestions').classList.remove('show'); }
    function selectSuggestion(route) { 
        document.getElementById('route-input').value = route; 
        handleInput(); 
        hideSuggestions(); 
        searchRoute(); 
    }

    function searchRoute() {
        const inputEl = document.getElementById('route-input');
        const input = inputEl.value.trim().toUpperCase();
        if (!input) return;
        if (validRouteSet.size > 0 && !validRouteSet.has(input)) { alert('Êâæ‰∏çÂà∞Ê≠§Ë∑ØÁ∑öËôüÁ¢º'); inputEl.focus(); return; }
        inputEl.blur(); hideSuggestions(); 
        
        if(document.getElementById('empty-state')) {
             document.getElementById('cards-container').innerHTML = '';
        }
        createCard(input);
    }
    
    // ==========================================================
    //  BusRouteCard Class
    // ==========================================================
    class BusRouteCard {
        constructor(route, containerId, savedState = null) {
            this.id = containerId; 
            this.route = route;
            this.dir = savedState ? savedState.dir : 'outbound';
            this.markedSeq = savedState ? savedState.markedSeq : null; 
            this.filteredSeq = savedState ? savedState.filteredSeq : null; 
            this.currentDestName = savedState ? savedState.destName : ''; 

            this.lastRows = []; 
            this.element = null; 
        }

        init() {
            const emptyState = document.getElementById('empty-state');
            if (emptyState) emptyState.remove();

            const div = document.createElement('div');
            div.className = 'card';
            div.id = this.id;
            div.setAttribute('draggable', 'true');

            div.innerHTML = `
                <div class="card-header">
                    <div class="drag-handle">‚â°</div>
                    <div class="close-card-btn" onclick="window.cardRegistry['${this.id}'].destroy()">‚úï</div>
                    
                    <div class="header-top">
                        <div style="display:flex; align-items:center;">
                            <span class="icon">üöå</span>
                            <span class="card-title">‰πùÂ∑¥ ${this.route}</span>
                        </div>
                        <div style="font-size:0.8rem; opacity:0.8" class="update-time"></div>
                    </div>

                    <div class="direction-switch" style="display:flex;">
                        <span class="dir-opt btn-out active" onclick="window.cardRegistry['${this.id}'].switchDirection('outbound')">ÂæÄ ËºâÂÖ•‰∏≠...</span>
                        <span class="dir-opt btn-in" onclick="window.cardRegistry['${this.id}'].switchDirection('inbound')">ÂæÄ ËºâÂÖ•‰∏≠...</span>
                    </div>
                </div>

                <div class="card-content">
                    <div class="status-msg">Ê≠£Âú®ÂàÜÊûêË∑ØÁ∑öË≥áÊñô...</div>
                </div>
            `;
            
            const container = document.getElementById('cards-container');
            container.appendChild(div);
            this.element = div;
            
            setTimeout(() => { div.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
            
            this.initDragEvents(div);
            this.updateDirectionUI(); 

            this.fetchRouteBoundaries().then(() => {
                this.fetchBusData();
            });
        }

        updateDirectionUI() {
            const btnOut = this.element.querySelector('.btn-out');
            const btnIn = this.element.querySelector('.btn-in');
            btnOut.classList.toggle('active', this.dir === 'outbound');
            btnIn.classList.toggle('active', this.dir === 'inbound');
        }

        initDragEvents(cardEl) {
            const handle = cardEl.querySelector('.drag-handle');
            const container = document.getElementById('cards-container');
            
            cardEl.addEventListener('dragstart', () => { cardEl.classList.add('dragging'); });
            cardEl.addEventListener('dragend', () => { cardEl.classList.remove('dragging'); });
            
            handle.addEventListener('touchstart', (e) => { cardEl.classList.add('dragging'); }, { passive: true });
            handle.addEventListener('touchend', () => { cardEl.classList.remove('dragging'); });
            handle.addEventListener('touchmove', (e) => {
                const touchLocation = e.targetTouches[0];
                const afterElement = getDragAfterElement(container, touchLocation.clientY, '.card');
                if (afterElement == null) container.appendChild(cardEl);
                else container.insertBefore(cardEl, afterElement);
                e.preventDefault();
            }, { passive: false });
        }

        destroy() {
            if (this.element) {
                this.element.style.transition = 'opacity 0.3s, transform 0.3s';
                this.element.style.opacity = '0';
                this.element.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    this.element.remove();
                    delete window.cardRegistry[this.id];
                    if (Object.keys(window.cardRegistry).length === 0) {
                        clearAllCards(true);
                    }
                }, 300);
            }
        }

        async fetchRouteBoundaries() {
            const [outStops, inStops] = await Promise.all([
                getRouteStops(this.route, 'outbound'), 
                getRouteStops(this.route, 'inbound')
            ]);
            
            let outName = 'ÂéªÁ®ã';
            let inName = 'ÂõûÁ®ã';

            const btnOut = this.element.querySelector('.btn-out');
            const btnIn = this.element.querySelector('.btn-in');

            if (outStops && outStops.length > 0) {
                const name = await getStopName(outStops[outStops.length - 1].stop);
                btnOut.innerText = `ÂæÄ ${name}`;
                outName = name;
            } else { btnOut.innerText = 'ÂéªÁ®ã (ÁÑ°Ë≥áÊñô)'; }

            if (inStops && inStops.length > 0) {
                const name = await getStopName(inStops[inStops.length - 1].stop);
                btnIn.innerText = `ÂæÄ ${name}`;
                btnIn.style.display = 'block'; 
                inName = name;
            } else {
                btnIn.style.display = 'none'; 
                btnOut.innerText += ' (Âæ™Áí∞Á∑ö)';
            }
            
            this.destMap = { outbound: outName, inbound: inName };
            this.currentDestName = this.destMap[this.dir];
        }

        switchDirection(dir) {
            if (this.dir === dir) return;
            this.dir = dir;
            this.markedSeq = null; this.filteredSeq = null; 
            
            if(this.destMap) this.currentDestName = this.destMap[dir];

            this.updateDirectionUI();
            this.fetchBusData();
        }

        async fetchBusData() {
            const listEl = this.element.querySelector('.card-content');
            const timeEl = this.element.querySelector('.update-time');
            if(listEl.innerHTML.includes('Êö´ÁÑ°Ë≥áÊñô') || listEl.innerHTML.includes('Ê≠£Âú®ÂàÜÊûê')) {
                listEl.classList.add('fading');
            }
            timeEl.innerText = 'Êõ¥Êñ∞‰∏≠...';
            try {
                const routeStops = await getRouteStops(this.route, this.dir);
                if (!routeStops || routeStops.length === 0) {
                    listEl.innerHTML = '<div class="status-msg">Ê≠§ÊñπÂêëÁÑ°ËªäÁ´ôË≥áÊñô</div>';
                    listEl.classList.remove('fading'); return;
                }
                const etaRes = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/route-eta/${this.route}/1`);
                const etaData = await etaRes.json();
                const allEtas = etaData.data || [];
                const rows = await Promise.all(routeStops.map(async (stopInfo) => {
                    const name = await getStopName(stopInfo.stop);
                    const apiDir = this.dir === 'outbound' ? 'O' : 'I';
                    const stopEtas = allEtas.filter(e => 
                        e.seq === parseInt(stopInfo.seq) && e.dir === apiDir && e.eta != null
                    ).sort((a, b) => new Date(a.eta) - new Date(b.eta));
                    return { seq: parseInt(stopInfo.seq), name: name, etas: stopEtas };
                }));
                this.lastRows = rows; 
                this.renderList(this.lastRows); 
                this.applyVisualState();   
                timeEl.innerText = 'Êõ¥Êñ∞Êñº ' + new Date().toLocaleTimeString('zh-HK', {hour:'2-digit', minute:'2-digit'});
            } catch (e) {
                console.error(e);
                listEl.innerHTML = '<div class="status-msg error">Ë≥áÊñôËºâÂÖ•Â§±Êïó</div>';
            } finally {
                listEl.classList.remove('fading');
            }
        }

        renderList(rows) {
            const listEl = this.element.querySelector('.card-content');
            if (rows.length === 0) {
                listEl.innerHTML = '<div class="status-msg">Êö´ÁÑ°Ë≥áÊñô</div>';
                return;
            }
            const html = rows.sort((a, b) => a.seq - b.seq).map(row => {
                let timeHtml = '';
                if (row.etas.length === 0) {
                    timeHtml = '<span style="color:var(--text-sub); font-size:0.85rem;">Êö´ÁÑ°Áè≠Ê¨°</span>';
                } else {
                    timeHtml = row.etas.slice(0, 3).map(e => {
                        const mins = getMins(e.eta);
                        const d = new Date(e.eta);
                        const timeStr = ('0' + d.getHours()).slice(-2) + ':' + ('0' + d.getMinutes()).slice(-2);
                        const isUrgent = mins === 'Âç≥Â∞á' || mins === '0ÂàÜ' || mins === '1ÂàÜ';
                        return `<span class="eta-minutes ${isUrgent ? 'urgent' : ''}" data-min="${mins}" data-time="${timeStr}" style="margin-left:4px;">${mins}</span>`;
                    }).join('');
                }
                return `
                <div class="schedule-item" data-seq="${row.seq}" onclick="window.cardRegistry['${this.id}'].toggleEtas(this)">
                    <div class="stop-info">
                        <span class="dest-seq" onclick="window.cardRegistry['${this.id}'].togglePin(event, ${row.seq})">${row.seq}</span>
                        <span class="dest-name">${row.name}</span>
                    </div>
                    <div style="text-align:right; min-width:120px; flex-shrink:0;">
                        ${timeHtml}
                    </div>
                </div>`;
            }).join('');
            listEl.innerHTML = html;
        }

        togglePin(e, seq) {
            e.stopPropagation();
            if (this.filteredSeq === seq) {
                this.filteredSeq = null; this.markedSeq = null;
            } else if (this.markedSeq === seq) {
                this.filteredSeq = seq;
            } else {
                this.markedSeq = seq; this.filteredSeq = null;
            }
            this.applyVisualState();
        }

        applyVisualState() {
            const items = this.element.querySelectorAll('.schedule-item');
            items.forEach(item => {
                const seq = parseInt(item.getAttribute('data-seq'));
                const seqSpan = item.querySelector('.dest-seq');
                if (this.filteredSeq !== null && this.filteredSeq !== seq) item.classList.add('hidden-row');
                else item.classList.remove('hidden-row');
                
                if (this.filteredSeq !== null && this.filteredSeq === seq) item.classList.add('no-border');
                else item.classList.remove('no-border');

                if (this.markedSeq === seq) {
                    seqSpan.innerText = 'üìå';
                    seqSpan.style.opacity = '1';
                } else {
                    seqSpan.innerText = seq;
                    seqSpan.style.opacity = '';
                }
            });
        }

        toggleEtas(row) {
            const spans = row.querySelectorAll('.eta-minutes');
            if(spans.length === 0) return;
            const isShowingTime = row.classList.contains('mode-time');
            if (isShowingTime) {
                row.classList.remove('mode-time');
                spans.forEach(span => { span.innerText = span.getAttribute('data-min'); span.classList.remove('show-real-time'); });
            } else {
                row.classList.add('mode-time');
                spans.forEach(span => { span.innerText = span.getAttribute('data-time'); span.classList.add('show-real-time'); });
            }
        }
    }

    function getDragAfterElement(container, y, selector) {
        const draggableElements = [...container.querySelectorAll(`${selector}:not(.dragging)`)];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
            else return closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    async function preloadAllRoutes() {
        try {
            const res = await fetch('https://data.etabus.gov.hk/v1/transport/kmb/route/');
            const json = await res.json();
            const routeMap = new Map();
            if (json.data) {
                json.data.forEach(r => {
                    if (!routeMap.has(r.route)) routeMap.set(r.route, { route: r.route, orig: r.orig_tc, dest: r.dest_tc });
                    validRouteSet.add(r.route);
                });
            }
            allRoutesDB = Array.from(routeMap.values()).sort((a, b) => a.route.localeCompare(b.route, undefined, {numeric: true, sensitivity: 'base'}));
        } catch (e) { console.error(e); }
    }

    async function getRouteStops(route, dir) {
        try { const res = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/route-stop/${route}/${dir}/1`); const data = await res.json(); return data.data; } catch { return []; }
    }
    async function getStopName(stopId) {
        if (kmbStopCache[stopId]) return kmbStopCache[stopId];
        try { const res = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/stop/${stopId}`); const data = await res.json(); kmbStopCache[stopId] = data.data.name_tc; return data.data.name_tc; } catch { return 'Êú™Áü•ËªäÁ´ô'; }
    }
    const getMins = (iso) => { if (!iso) return '--'; const diff = Math.floor((new Date(iso) - new Date()) / 60000); return diff <= 0 ? 'Âç≥Â∞á' : `${diff}ÂàÜ`; };

    function toggleDarkMode() {
        const isChecked = document.getElementById('dm-toggle').checked;
        if (isChecked) { document.body.classList.add('dark-mode'); localStorage.setItem('darkMode', 'enabled'); }
        else { document.body.classList.remove('dark-mode'); localStorage.setItem('darkMode', 'disabled'); }
    }
    function initDarkMode() {
        const savedMode = localStorage.getItem('darkMode');
        if (savedMode === 'enabled' || (!savedMode && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.body.classList.add('dark-mode'); document.getElementById('dm-toggle').checked = true;
        }
    }
</script>
</body>
</html>
