<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS Web App Ë®≠ÂÆö -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Â∑¥Â£´Áè≠Ê¨°">

    <!-- iOS ‰∏ªÁï´Èù¢ÂúñÁ§∫ -->
    <link rel="apple-touch-icon" sizes="180x180" href="bus-logo.jpg">
    <!-- ÁÄèË¶ΩÂô®ÂàÜÈ†ÅÂúñÁ§∫ -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüöå%3C/text%3E%3C/svg%3E">

    <title>È¶ôÊ∏Ø‰∫§ÈÄöÁè≠Ê¨°Êü•Ë©¢</title>
    <style>
        :root {
            --bg-color: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-main: #1C1C1E;
            --text-sub: #8E8E93;
            --kmb-red: #E3001B;
            --ctb-yellow: #F9D300;
            --nlb-green: #007D8F;
            --mtr-purple: #5856D6;
            --accent: #007AFF;
            --separator: #E5E5EA;
            --sidebar-width: 280px;
        }
        body.dark-mode {
            --bg-color: #000000;
            --card-bg: #1C1C1E;
            --text-main: #FFFFFF;
            --text-sub: #98989D;
            --separator: #38383A;
            --ctb-yellow: #D1B100;
            --nlb-green: #0096AC;
            --mtr-purple: #5E5CE6;
        }
        * { -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        select, input, textarea { -webkit-user-select: auto; user-select: auto; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color); margin: 0; padding: env(safe-area-inset-top) 0 0 0;
            color: var(--text-main); height: 100dvh; display: flex; flex-direction: column;
            transition: background-color 0.3s, color 0.3s; overflow: hidden;
        }
        .container { flex: 1; display: flex; flex-direction: column; width: 100%; max-width: 600px; margin: 0 auto; overflow: hidden; position: relative; z-index: 1; }
        
        /* È†ÇÈÉ®ÊêúÂ∞ãÂçÄ */
        .search-area {
            padding: 12px 16px; background: var(--bg-color); display: flex; gap: 8px;
            z-index: 200; box-shadow: 0 1px 0 rgba(0,0,0,0.05); align-items: center;
        }
        .menu-btn { font-size: 1.5rem; padding: 4px 8px; cursor: pointer; color: var(--text-main); }
        .search-wrapper { position: relative; flex: 1; }
        .search-input {
            width: 100%; padding: 10px 32px 10px 14px; border-radius: 12px; border: none;
            background: var(--card-bg); color: var(--text-main); font-size: 1.1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); outline: none; transition: border 0.2s;
        }
        .search-input.shake { animation: shake 0.4s ease-in-out; border: 1px solid #FF3B30 !important; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-6px); }
            40%, 80% { transform: translateX(6px); }
        }
        .clear-input-btn {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            width: 20px; height: 20px; border-radius: 50%; background: rgba(142, 142, 147, 0.3);
            color: white; font-size: 12px; display: none; align-items: center; justify-content: center; cursor: pointer;
        }
        .suggestions-list {
            position: absolute; top: 110%; left: 0; right: 0; background: var(--card-bg);
            border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); max-height: 300px;
            overflow-y: auto; z-index: 1000; display: none;
        }
        .suggestions-list.show { display: block; border: 1px solid rgba(0,0,0,0.05); }
        .suggestion-item {
            padding: 12px 16px; border-bottom: 1px solid var(--separator); font-size: 1.05rem;
            color: var(--text-main); cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .suggestion-item:last-child { border-bottom: none; }
        .sug-left { display: flex; align-items: center; gap: 8px; }
        .sug-route { font-weight: 700; font-size: 1.1rem; }
        .sug-desc { font-size: 0.8rem; color: var(--text-sub); flex: 1; text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .co-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; color: white; font-weight: bold; width: 40px; text-align: center; }
        .badge-kmb { background: var(--kmb-red); }
        .badge-ctb { background: var(--ctb-yellow); color: white; text-shadow: 0 0 3px rgba(0,0,0,0.4); } 
        .badge-nlb { background: var(--nlb-green); }
        .badge-mtr { background: var(--mtr-purple); }
        .search-btn {
            padding: 0 16px; background: var(--accent); color: white; border: none; border-radius: 12px;
            font-weight: 600; font-size: 1rem; cursor: pointer; box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3); height: 42px;
        }
        .search-btn:active { transform: scale(0.96); opacity: 0.9; }
        
        /* ÂÖßÂÆπÂçÄ */
        .content-scroll { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 10px 16px; scroll-behavior: smooth; display: flex; flex-direction: column;}
        
        /* Âç°Áâá */
        .card {
            background: var(--card-bg); 
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.05); margin-bottom: 20px; position: relative;
            animation: slideIn 0.3s ease-out; 
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.3s ease, max-height 0.3s ease, margin-bottom 0.3s ease, padding 0.3s ease;
            flex-shrink: 0;
            overflow: hidden;
        }
        .card.dragging { opacity: 0.5; background: #f8f8f8; box-shadow: 0 10px 20px rgba(0,0,0,0.2); z-index: 100; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .card-header { 
            background: linear-gradient(135deg, #E3001B, #C20017); 
            padding: 12px 16px; color: white; display: flex; flex-direction: column; gap: 8px; 
            position: relative; padding-left: 40px;
            border-top-left-radius: 16px; border-top-right-radius: 16px;
        }
        .ctb-card .card-header { background: linear-gradient(135deg, var(--ctb-yellow), #E6C100); }
        .nlb-card .card-header { background: linear-gradient(135deg, var(--nlb-green), #005F6B); }
        .mtr-card .card-header { background: linear-gradient(135deg, var(--mtr-purple), #4a48b8); }

        .ctb-card .close-card-btn, .nlb-card .close-card-btn, .mtr-card .close-card-btn { background: rgba(0, 0, 0, 0.1); color: white; }
        
        /* ÊñπÂêëÊåâÈàïÊ®£Âºè */
        .dir-opt { flex: 1; text-align: center; font-size: 0.85rem; color: rgba(255, 255, 255, 0.7); padding: 6px 4px; border-radius: 6px; cursor: pointer; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* ‰∏çÂêåÂÖ¨Âè∏ÁöÑ Active ÁãÄÊÖãÊñáÂ≠óÈ°èËâ≤ */
        .dir-opt.active { background: white; color: var(--kmb-red); font-weight: 700; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .ctb-card .dir-opt.active { color: #C2A000; }
        .nlb-card .dir-opt.active { color: var(--nlb-green); }
        .mtr-card .dir-opt.active { color: var(--mtr-purple); }

        .drag-handle { position: absolute; top: 12px; left: 10px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: rgba(255, 255, 255, 0.6); cursor: grab; z-index: 15; }
        .close-card-btn { position: absolute; top: 10px; right: 10px; width: 28px; height: 28px; background: rgba(0, 0, 0, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; font-weight: bold; font-size: 14px; backdrop-filter: blur(4px); z-index: 10; }
        .header-top { display: flex; justify-content: space-between; align-items: center; padding-right: 30px; }
        .icon { font-size: 1.4rem; margin-right: 8px; }
        .card-title { font-size: 1.3rem; font-weight: 800; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .direction-switch { display: flex; background: rgba(0, 0, 0, 0.1); padding: 3px; border-radius: 8px; margin-top: 4px; }
        
        .card-content { padding: 4px 16px 16px; min-height: 50px; }
        
        /* Shared Schedule Item Style (Bus & MTR) */
        .schedule-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px dashed var(--separator); cursor: pointer; overflow: hidden; max-height: 100px; opacity: 1; transition: all 0.4s; }
        .schedule-item:last-child { border-bottom: none; }
        .schedule-item.hidden-row { max-height: 0; opacity: 0; padding: 0; margin: 0; border: none; pointer-events: none; }
        .stop-info { flex: 1; display: flex; align-items: center; overflow: hidden; padding-right: 10px; }
        .dest-name { font-size: 1.05rem; font-weight: 600; color: var(--text-main); }
        .dest-seq { color: var(--text-sub); font-size: 0.8rem; margin-right: 10px; font-weight: 400; display: inline-block; width: 30px; text-align: center; }
        
        .eta-container { display: flex; flex-wrap: wrap; justify-content: flex-end; align-items: center; min-width: 120px; text-align: right; }

        /* MTR Card Content */
        .mtr-direction-group { padding: 8px 0; }
        .mtr-direction-group:not(:last-child) { border-bottom: 1px dashed var(--separator); }

        .mtr-compact-eta {
            font-size: 1rem;
            text-align: right;
            margin-left: 6px;
            display: inline-flex;
            align-items: center;
        }

        .mtr-compact-eta .mtr-eta-details {
            font-size: 0.9rem;
            color: var(--text-sub);
            margin-left: 4px;
        }

        @keyframes pinDrop {
            0% { transform: translateY(-20px) scale(1.2); opacity: 0; }
            60% { transform: translateY(0) scale(1.0); opacity: 1; }
            80% { transform: translateY(-3px); }
            100% { transform: translateY(0); }
        }
        .pin-icon { display: inline-block; animation: pinDrop 0.4s ease-out; }

        /* Áµ±‰∏ÄÁöÑÊôÇÈñìËÜ†ÂõäÊ®£Âºè (Bus & MTR) - Ê∑∫Ëâ≤Ê®°Âºè‰∏ãÂº∑Âà∂Á∂†Ëâ≤/Á¥ÖËâ≤ */
        .eta-minutes { 
            font-size: 1rem; 
            color: #34C759; /* Green Text */
            font-weight: 700; 
            background: #E8F5E9; /* Light Green BG */
            padding: 4px 8px; 
            border-radius: 6px; 
            display: inline-block; 
            min-width: 45px; 
            text-align: center; 
            margin-left: 4px; 
        }
        
        /* Ê∑±Ëâ≤Ê®°Âºè‰∏ãÁöÑÁ∂†Ëâ≤Ê®£Âºè */
        body.dark-mode .eta-minutes { 
            background: rgba(52, 199, 89, 0.2); 
            color: #32D74B; 
        }
        
        /* Á∑äÊÄ•/Âç≥Â∞áÂà∞ÈÅî (Á¥ÖËâ≤) - Ê∑∫Ëâ≤Ê®°Âºè */
        .urgent { 
            color: #FF3B30 !important; 
            background: #FFEBEE !important; 
        }
        
        /* Á∑äÊÄ•/Âç≥Â∞áÂà∞ÈÅî (Á¥ÖËâ≤) - Ê∑±Ëâ≤Ê®°Âºè */
        body.dark-mode .urgent { 
            background: rgba(255, 69, 58, 0.2) !important; 
            color: #FF453A !important; 
        }
        
        /* ÁúüÂØ¶ÊôÇÈñìÈ°ØÁ§∫Ê®£Âºè (ÈÄèÊòéÂ∫ï) */
        .eta-minutes.show-real-time { 
            background: transparent !important; 
            color: var(--text-main) !important; 
            border: 1px solid rgba(142, 142, 147, 0.3); 
            font-family: "SF Pro Display", sans-serif; 
        }
        
        /* Êö´ÁÑ°Áè≠Ê¨°Ê®£Âºè */
        .no-schedule { color: var(--text-sub); font-size: 0.85rem; }

        .status-msg { text-align: center; padding: 40px 20px; color: var(--text-sub); }
        .fading { opacity: 0.5; pointer-events: none; }
        #empty-state { text-align: center; padding: 60px 20px; color: var(--text-sub); display: flex; flex-direction: column; align-items: center; }
        #empty-state .big-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.3; }

        /* Â∫ïÈÉ®Êñ∞Â¢û */
        #add-card-section { padding: 20px 0 40px; display: none; flex-direction: column; align-items: center; justify-content: center; flex-shrink: 0; }
        .add-circle-btn { width: 56px; height: 56px; border-radius: 50%; background: var(--card-bg); color: var(--accent); font-size: 2rem; border: none; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
        .add-circle-btn:active { transform: scale(0.9); }
        #add-search-wrapper { display: none; width: 100%; gap: 8px; animation: slideUp 0.2s ease-out; background: var(--bg-color); padding: 5px; border-radius: 12px; }
        #add-search-wrapper.active { display: flex; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Sidebar */
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; backdrop-filter: blur(2px); }
        .sidebar-overlay.active { opacity: 1; visibility: visible; }
        .sidebar { position: fixed; top: 0; left: -100%; width: 85%; max-width: 320px; height: 100%; background: var(--card-bg); z-index: 1001; transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; box-shadow: 2px 0 12px rgba(0,0,0,0.1); }
        .sidebar.active { left: 0; }
        .sidebar-header { padding: 20px 16px; border-bottom: 1px solid var(--separator); display: flex; justify-content: space-between; align-items: center; }
        .sidebar-title { font-size: 1.2rem; font-weight: 700; color: var(--text-main); }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 10px 0; }
        .sidebar-settings { padding: 15px 16px; border-bottom: 1px solid var(--separator); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.02); }
        .setting-label { font-size: 1rem; color: var(--text-main); font-weight: 600; }
        .ios-switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .ios-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #E9E9EA; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: #34C759; }
        input:checked + .slider:before { transform: translateX(20px); }
        body.dark-mode .slider { background-color: #39393D; }
        .saved-item { padding: 12px 16px; border-bottom: 1px solid var(--separator); display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: var(--card-bg); transition: background 0.2s; position: relative; }
        .saved-item.dragging { opacity: 0.5; background: #e0e0e0; }
        
        .saved-drag-handle, .delete-btn { display: none; }
        .sidebar-content.editing .saved-drag-handle, .sidebar-content.editing .delete-btn { display: flex; } 
        .sidebar-content.editing .saved-item { padding-left: 10px; }
        
        .saved-drag-handle { margin-right: 16px; color: var(--text-sub); font-size: 1.3rem; align-items: center; }
        
        .saved-info { flex: 1; pointer-events: none; }
        .saved-name { font-size: 1rem; font-weight: 600; color: var(--text-main); display: flex; align-items: center; gap: 6px;}
        .default-badge { font-size: 0.65rem; color: white; background: #34C759; padding: 2px 6px; border-radius: 4px; font-weight: 700; text-transform: uppercase; }
        .saved-detail { font-size: 0.8rem; color: var(--text-sub); margin-top: 2px; }
        
        .delete-btn { 
            width: 28px; height: 28px; 
            border-radius: 50%; 
            background: #FF3B30; color: white; 
            align-items: center; justify-content: center; 
            font-size: 0.9rem; margin-left: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 2; 
        }

        .sidebar-footer { padding: 16px; border-top: 1px solid var(--separator); display: flex; gap: 10px; }
        .save-all-btn { flex: 1; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 1rem; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .edit-mode-btn { width: 48px; height: 48px; flex-shrink: 0; background: #F2F2F7; color: var(--text-main); border: none; border-radius: 12px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        body.dark-mode .edit-mode-btn { background: #2C2C2E; }
        .edit-mode-btn.active { background: var(--kmb-red); color: white; }
    </style>
</head>
<body>

<div class="sidebar-overlay" id="overlay" onclick="toggleSidebar(false)"></div>
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <span class="sidebar-title">Â∑≤ÂÑ≤Â≠òÈ†ÖÁõÆ</span>
        <span onclick="toggleSidebar(false)" style="cursor:pointer; padding:5px; font-size:1.2rem;">‚úï</span>
    </div>
    <div class="sidebar-settings">
        <span class="setting-label">ÈªëÊöóÊ®°Âºè</span>
        <label class="ios-switch"><input type="checkbox" id="dm-toggle" onchange="toggleDarkMode()"><span class="slider"></span></label>
    </div>
    <div class="sidebar-content" id="saved-list-container"></div>
    <div class="sidebar-footer">
        <button class="save-all-btn" onclick="saveCurrentAsGroup()">Ôºã ÂÑ≤Â≠òÁï∂ÂâçÁâàÈù¢</button>
        <button class="edit-mode-btn" id="edit-btn" onclick="toggleEditMode()">‚úé</button>
    </div>
</div>

<div class="container">
    <div class="search-area">
        <div class="menu-btn" onclick="toggleSidebar(true)">‚ò∞</div>
        <div class="search-wrapper">
            <input type="text" id="route-input" class="search-input" placeholder="Ëº∏ÂÖ•Ë∑ØÁ∑ö / Ê∏ØÈêµÁ∂´" value="" autocomplete="off"
                   oninput="handleInput(this, 'suggestions', 'clear-search')" 
                   onfocus="handleInput(this, 'suggestions', 'clear-search')"
                   onkeypress="if(event.key==='Enter') searchTopItem()">
            <div id="clear-search" class="clear-input-btn" onclick="clearSearch('route-input')">‚úï</div>
            <div id="suggestions" class="suggestions-list"></div>
        </div>
        <button id="search-btn" class="search-btn" onclick="searchTopItem()">Êü•Ë©¢</button>
    </div>

    <div class="content-scroll">
        <div id="cards-container">
            <div id="empty-state">
                <div class="big-icon">üöç</div>
                <div>Ë´ãËº∏ÂÖ•Â∑¥Â£´Ë∑ØÁ∑öÊàñÊ∏ØÈêµÁ∂´Ë∑ØÈñãÂßãÊü•Ë©¢</div>
            </div>
        </div>
        <!-- Â∫ïÈÉ®Êñ∞Â¢ûÊåâÈàïÂçÄÂüü -->
        <div id="add-card-section">
            <button id="show-add-btn" class="add-circle-btn" onclick="toggleAddSearch(true)">Ôºã</button>
            <div id="add-search-wrapper">
                <div class="search-wrapper">
                    <input type="text" id="add-route-input" class="search-input" placeholder="Ëº∏ÂÖ•Ë∑ØÁ∑ö / Ê∏ØÈêµÁ∂´" value="" autocomplete="off"
                           oninput="handleInput(this, 'add-suggestions', 'add-clear-search')" 
                           onfocus="handleInput(this, 'add-suggestions', 'add-clear-search')"
                           onkeypress="if(event.key==='Enter') addItem()">
                    <div id="add-clear-search" class="clear-input-btn" onclick="clearSearch('add-route-input')">‚úï</div>
                    <div id="add-suggestions" class="suggestions-list"></div>
                </div>
                <button class="search-btn" onclick="addItem()">Êñ∞Â¢û</button>
                <button class="search-btn" style="background:var(--text-sub)" onclick="toggleAddSearch(false)">‚úï</button>
            </div>
        </div>
    </div>
</div>

<script>
    const KMB_API = 'https://data.etabus.gov.hk/v1/transport/kmb';
    const CTB_API = 'https://rt.data.gov.hk/v2/transport/citybus';
    const NLB_API = 'https://rt.data.gov.hk/v2/transport/nlb';
    const MTR_API = 'https://rt.data.gov.hk/v1/transport/mtr/getSchedule.php';
    
    let stopCache = {};
    let allRoutesDB = []; 
    let nlbRouteMap = {};
    let allMtrStations = [];
    let allMtrLines = [];
    let mtrStationNames = {};

    window.cardRegistry = {};
    let cardCounter = 0;
    let isEditMode = false;

    document.addEventListener('DOMContentLoaded', () => {
        initDarkMode();
        buildMtrDb();
        preloadAllRoutes(); 
        StorageManager.loadAll(); 
        if (StorageManager.getList().length > 0) loadSavedItem(StorageManager.getList()[0].id);

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-wrapper')) {
                document.querySelectorAll('.suggestions-list').forEach(el => el.classList.remove('show'));
            }
        });
        
        const setupDrag = (containerId, selector) => {
            const el = document.getElementById(containerId);
            el.addEventListener('dragover', e => {
                e.preventDefault();
                const draggable = document.querySelector(`${selector}.dragging`);
                if (!draggable) return;
                const afterEl = getDragAfterElement(el, e.clientY, selector);
                if (afterEl == null) el.appendChild(draggable); else el.insertBefore(draggable, afterEl);
            });
        };
        setupDrag('cards-container', '.card');
        setupDrag('saved-list-container', '.saved-item');
    });

    // --- MTR Data (Strictly Ordered Arrays) ---
    function buildMtrDb() {
        const MTR_DATA = {
            'AEL': { name: 'Ê©üÂ†¥Âø´Á∂´', stations: [
                { c: 'HOK', n: 'È¶ôÊ∏Ø' }, { c: 'KOW', n: '‰πùÈæç' }, { c: 'TSY', n: 'ÈùíË°£' },
                { c: 'AIR', n: 'Ê©üÂ†¥' }, { c: 'AWE', n: 'ÂçöË¶ΩÈ§®' }
            ]},
            'TCL': { name: 'Êù±Ê∂åÁ∂´', stations: [
                { c: 'HOK', n: 'È¶ôÊ∏Ø' }, { c: 'KOW', n: '‰πùÈæç' }, { c: 'OLY', n: 'Â•ßÈÅã' },
                { c: 'NAC', n: 'ÂçóÊòå' }, { c: 'LAK', n: 'ËçîÊôØ' }, { c: 'TSY', n: 'ÈùíË°£' },
                { c: 'SUN', n: 'Ê¨£Êæ≥' }, { c: 'TUC', n: 'Êù±Ê∂å' }
            ]},
            'TML': { name: 'Â±ØÈ¶¨Á∂´', stations: [
                { c: 'WKS', n: 'ÁÉèÊ∫™Ê≤ô' }, { c: 'MOS', n: 'È¶¨ÈûçÂ±±' }, { c: 'HEO', n: 'ÊÅÜÂÆâ' },
                { c: 'TSH', n: 'Â§ßÊ∞¥Âùë' }, { c: 'SHM', n: 'Áü≥ÈñÄ' }, { c: 'CIO', n: 'Á¨¨‰∏ÄÂüé' },
                { c: 'STW', n: 'Ê≤ôÁî∞Âúç' }, { c: 'CKT', n: 'ËªäÂÖ¨Âªü' }, { c: 'TAW', n: 'Â§ßÂúç' },
                { c: 'HIK', n: 'È°ØÂæë' }, { c: 'DIH', n: 'ÈëΩÁü≥Â±±' }, { c: 'KAT', n: 'ÂïüÂæ∑' },
                { c: 'SUW', n: 'ÂÆãÁöáËá∫' }, { c: 'TKW', n: 'ÂúüÁìúÁÅ£' }, { c: 'HOM', n: '‰ΩïÊñáÁî∞' },
                { c: 'HUH', n: 'Á¥ÖÁ£°' }, { c: 'ETS', n: 'Â∞ñÊù±' }, { c: 'AUS', n: 'ÊüØÂ£´Áî∏' },
                { c: 'NAC', n: 'ÂçóÊòå' }, { c: 'MEF', n: 'ÁæéÂ≠ö' }, { c: 'TWW', n: 'ËçÉÁÅ£Ë•ø' },
                { c: 'KSR', n: 'Èå¶‰∏äË∑Ø' }, { c: 'YUL', n: 'ÂÖÉÊúó' }, { c: 'LOP', n: 'ÊúóÂ±è' },
                { c: 'TIS', n: 'Â§©Ê∞¥Âúç' }, { c: 'SIH', n: 'ÂÖÜÂ∫∑' }, { c: 'TUM', n: 'Â±ØÈñÄ' }
            ]},
            'TKL': { name: 'Â∞áËªçÊæ≥Á∂´', stations: [
                { c: 'NOP', n: 'ÂåóËßí' }, { c: 'QUB', n: 'È∞ÇÈ≠öÊ∂å' }, { c: 'YAT', n: 'Ê≤πÂ°ò' },
                { c: 'TIK', n: 'Ë™øÊôØÂ∂∫' }, { c: 'TKO', n: 'Â∞áËªçÊæ≥' }, { c: 'HAH', n: 'ÂùëÂè£' },
                { c: 'POA', n: 'ÂØ∂Áê≥' }, { c: 'LHP', n: 'Â∫∑Âüé' } 
            ]},
            'EAL': { name: 'Êù±ÈêµÁ∂´', stations: [
                { c: 'ADM', n: 'ÈáëÈêò' }, { c: 'EXC', n: 'ÊúÉÂ±ï' }, { c: 'HUH', n: 'Á¥ÖÁ£°' },
                { c: 'MKK', n: 'Êó∫ËßíÊù±' }, { c: 'KOT', n: '‰πùÈæçÂ°ò' }, { c: 'TAW', n: 'Â§ßÂúç' },
                { c: 'SHT', n: 'Ê≤ôÁî∞' }, { c: 'FOT', n: 'ÁÅ´ÁÇ≠' }, { c: 'RAC', n: 'È¶¨Â†¥' },
                { c: 'UNI', n: 'Â§ßÂ≠∏' }, { c: 'TAP', n: 'Â§ßÂüîÂ¢ü' }, { c: 'TWO', n: 'Â§™Âíå' },
                { c: 'FAN', n: 'Á≤âÂ∂∫' }, { c: 'SHS', n: '‰∏äÊ∞¥' }, { c: 'LOW', n: 'ÁæÖÊπñ' },
                { c: 'LMC', n: 'ËêΩÈ¶¨Ê¥≤' }
            ]},
            'SIL': { name: 'ÂçóÊ∏ØÂ≥∂Á∂´', stations: [
                { c: 'ADM', n: 'ÈáëÈêò' }, { c: 'OCP', n: 'Êµ∑Ê¥ãÂÖ¨Âúí' }, { c: 'WCH', n: 'ÈªÉÁ´πÂùë' },
                { c: 'LET', n: 'Âà©Êù±' }, { c: 'SOH', n: 'Êµ∑ÊÄ°ÂçäÂ≥∂' }
            ]},
            'TWL': { name: 'ËçÉÁÅ£Á∂´', stations: [
                { c: 'CEN', n: '‰∏≠Áí∞' }, { c: 'ADM', n: 'ÈáëÈêò' }, { c: 'TST', n: 'Â∞ñÊ≤ôÂíÄ' },
                { c: 'JOR', n: '‰ΩêÊï¶' }, { c: 'YMT', n: 'Ê≤πÈ∫ªÂú∞' }, { c: 'MOK', n: 'Êó∫Ëßí' },
                { c: 'PRE', n: 'Â§™Â≠ê' }, { c: 'SSP', n: 'Ê∑±Ê∞¥Âüó' }, { c: 'CSW', n: 'Èï∑Ê≤ôÁÅ£' },
                { c: 'LCK', n: 'ËçîÊûùËßí' }, { c: 'MEF', n: 'ÁæéÂ≠ö' }, { c: 'LAK', n: 'ËçîÊôØ' },
                { c: 'KWF', n: 'ËëµËä≥' }, { c: 'KWH', n: 'ËëµËàà' }, { c: 'TWH', n: 'Â§ßÁ™©Âè£' },
                { c: 'TSW', n: 'ËçÉÁÅ£' }
            ]},
            'ISL': { name: 'Ê∏ØÂ≥∂Á∂´', stations: [
                { c: 'KET', n: 'Â†ÖÂ∞ºÂú∞Âüé' }, { c: 'HKU', n: 'È¶ôÊ∏ØÂ§ßÂ≠∏' }, { c: 'SYP', n: 'Ë•øÁáüÁõ§' },
                { c: 'SHW', n: '‰∏äÁí∞' }, { c: 'CEN', n: '‰∏≠Áí∞' }, { c: 'ADM', n: 'ÈáëÈêò' },
                { c: 'WAC', n: 'ÁÅ£‰ªî' }, { c: 'CAB', n: 'ÈäÖÈëºÁÅ£' }, { c: 'TIH', n: 'Â§©Âêé' },
                { c: 'FOH', n: 'ÁÇÆÂè∞Â±±' }, { c: 'NOP', n: 'ÂåóËßí' }, { c: 'QUB', n: 'È∞ÇÈ≠öÊ∂å' },
                { c: 'TAK', n: 'Â§™Âè§' }, { c: 'SWH', n: 'Ë•øÁÅ£Ê≤≥' }, { c: 'SKW', n: 'Á≠≤ÁÆïÁÅ£' },
                { c: 'HFC', n: 'ÊùèËä±ÈÇ®' }, { c: 'CHW', n: 'Êü¥ÁÅ£' }
            ]},
            'KTL': { name: 'ËßÄÂ°òÁ∂´', stations: [
                { c: 'WHA', n: 'ÈªÉÂüî' }, { c: 'HOM', n: '‰ΩïÊñáÁî∞' }, { c: 'YMT', n: 'Ê≤πÈ∫ªÂú∞' },
                { c: 'MOK', n: 'Êó∫Ëßí' }, { c: 'PRE', n: 'Â§™Â≠ê' }, { c: 'SKM', n: 'Áü≥Á°§Â∞æ' },
                { c: 'KOT', n: '‰πùÈæçÂ°ò' }, { c: 'LOF', n: 'Ê®ÇÂØå' }, { c: 'WTS', n: 'ÈªÉÂ§ß‰ªô' },
                { c: 'DIH', n: 'ÈëΩÁü≥Â±±' }, { c: 'CHH', n: 'ÂΩ©Ëôπ' }, { c: 'KOB', n: '‰πùÈæçÁÅ£' },
                { c: 'NTK', n: 'ÁâõÈ†≠Ëßí' }, { c: 'KWT', n: 'ËßÄÂ°ò' }, { c: 'LAT', n: 'ËóçÁî∞' },
                { c: 'YAT', n: 'Ê≤πÂ°ò' }, { c: 'TIK', n: 'Ë™øÊôØÂ∂∫' }
            ]},
            'DRL': { name: 'Ëø™Â£´Â∞ºÁ∂´', stations: [
                { c: 'SUN', n: 'Ê¨£Êæ≥' }, { c: 'DIS', n: 'Ëø™Â£´Â∞º' }
            ]}
        };

        allMtrLines = Object.entries(MTR_DATA).map(([lineCode, lineData]) => ({
            lineCode,
            lineName: lineData.name,
            stations: lineData.stations.reduce((acc, s) => { acc[s.c] = s.n; return acc; }, {}),
            orderedStations: lineData.stations
        }));

        for (const [lineCode, lineData] of Object.entries(MTR_DATA)) {
            lineData.stations.forEach(s => {
                allMtrStations.push({ lineCode, staCode: s.c, lineName: lineData.name, staName: s.n });
                if (!mtrStationNames[s.c]) mtrStationNames[s.c] = s.n;
            });
        }
    }

    const LINE_TERMINALS = {
        'AEL': { UP: 'ÂçöË¶ΩÈ§®', DOWN: 'È¶ôÊ∏Ø' }, 'TCL': { UP: 'Êù±Ê∂å', DOWN: 'È¶ôÊ∏Ø' },
        'TML': { UP: 'Â±ØÈñÄ', DOWN: 'ÁÉèÊ∫™Ê≤ô' }, 'TKL': { UP: 'ÂØ∂Áê≥ / Â∫∑Âüé', DOWN: 'ÂåóËßí' },
        'EAL': { UP: 'ÁæÖÊπñ / ËêΩÈ¶¨Ê¥≤', DOWN: 'ÈáëÈêò' }, 'SIL': { UP: 'Êµ∑ÊÄ°ÂçäÂ≥∂', DOWN: 'ÈáëÈêò' },
        'TWL': { UP: 'ËçÉÁÅ£', DOWN: '‰∏≠Áí∞' }, 'ISL': { UP: 'Êü¥ÁÅ£', DOWN: 'Â†ÖÂ∞ºÂú∞Âüé' },
        'KTL': { UP: 'Ë™øÊôØÂ∂∫', DOWN: 'ÈªÉÂüî' }, 'DRL': { UP: 'Ëø™Â£´Â∞º', DOWN: 'Ê¨£Êæ≥' }
    };

    // --- Storage Manager ---
    const StorageManager = {
        key: 'hk_transport_saved_list',
        tempList: null,
        getList: () => (isEditMode && StorageManager.tempList) ? StorageManager.tempList : JSON.parse(localStorage.getItem(StorageManager.key) || '[]'),
        saveItem: (name, data) => {
            let list = JSON.parse(localStorage.getItem(StorageManager.key) || '[]');
            list.push({ id: Date.now(), name: name, data: data });
            localStorage.setItem(StorageManager.key, JSON.stringify(list));
            if (isEditMode) StorageManager.tempList = list;
            StorageManager.renderList();
        },
        deleteItem: (id) => {
            const filter = list => list.filter(item => item.id !== id);
            if (isEditMode) StorageManager.tempList = filter(StorageManager.tempList);
            else localStorage.setItem(StorageManager.key, JSON.stringify(filter(StorageManager.getList())));
            StorageManager.renderList();
        },
        renameItem: (id) => {
            if (!isEditMode) return;
            const item = StorageManager.tempList.find(x => x.id === id);
            const newName = prompt("Ë´ãËº∏ÂÖ•Êñ∞ÂêçÁ®±:", item ? item.name : "");
            if (item && newName && newName.trim()) { item.name = newName.trim(); StorageManager.renderList(); }
        },
        updateOrder: () => {
            if (!isEditMode) return;
            const els = document.querySelectorAll('#saved-list-container .saved-item');
            const oldList = StorageManager.tempList;
            StorageManager.tempList = Array.from(els).map(el => oldList.find(x => x.id === parseInt(el.dataset.id))).filter(x=>x);
            StorageManager.renderList();
        },
        commit: () => { if (StorageManager.tempList) { localStorage.setItem(StorageManager.key, JSON.stringify(StorageManager.tempList)); StorageManager.tempList = null; } },
        discard: () => { StorageManager.tempList = null; },
        initTemp: () => { StorageManager.tempList = JSON.parse(localStorage.getItem(StorageManager.key) || '[]'); },
        loadAll: () => { StorageManager.renderList(); },
        renderList: () => {
            const list = StorageManager.getList();
            const container = document.getElementById('saved-list-container');
            if (list.length === 0) { container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-sub);">Êö´ÁÑ°ÂÑ≤Â≠òÈ†ÖÁõÆ</div>'; return; }
            container.innerHTML = list.map((item, i) => {
                const isDefault = i === 0;
                let desc;
                const firstItem = item.data[0];
                 if (firstItem.type === 'MTR_LINE') {
                    const line = allMtrLines.find(l => l.lineCode === firstItem.lineCode);
                    desc = `[Ê∏ØÈêµ] ${line.lineName}`;
                } else if (firstItem.type === 'MTR') {
                    const station = allMtrStations.find(s => s.staCode === firstItem.staCode);
                    desc = `[Ê∏ØÈêµ] ${station.staName} (${station.lineName})`;
                } else {
                     desc = `[${firstItem.co||'KMB'}] ${firstItem.route} ${firstItem.destName ? 'ÂæÄ '+firstItem.destName : (firstItem.dir==='outbound'?'ÂéªÁ®ã':'ÂõûÁ®ã')}`;
                }
                if (item.data.length > 1) desc = `${item.data.length} ÂÄãÈ†ÖÁõÆÁµÑÂêà`;
                
                return `
                    <div class="saved-item" draggable="${isEditMode}" data-id="${item.id}" onclick="onSavedItemClick(${item.id})">
                        <div class="saved-drag-handle">‚â°</div>
                        <div class="saved-info">
                            <div class="saved-name">${item.name} ${isDefault ? '<span class="default-badge">È†êË®≠</span>' : ''}</div>
                            <div class="saved-detail">${desc}</div>
                        </div>
                        <div class="delete-btn" onclick="deleteSaved(event, ${item.id})">üóë</div>
                    </div>`;
            }).join('');
            container.classList.toggle('editing', isEditMode);
            StorageManager.bindEvents();
        },
        bindEvents: () => {
            document.querySelectorAll('.saved-item').forEach(item => {
                item.addEventListener('dragstart', () => item.classList.add('dragging'));
                item.addEventListener('dragend', () => { item.classList.remove('dragging'); if(isEditMode) StorageManager.updateOrder(); });
            });
        }
    };

    // --- Sidebar & UI Actions ---
    function toggleSidebar(show) {
        const sb = document.getElementById('sidebar'), ov = document.getElementById('overlay');
        if (show) { sb.classList.add('active'); ov.classList.add('active'); }
        else {
            if (isEditMode) { isEditMode = false; StorageManager.discard(); document.getElementById('edit-btn').innerHTML = '‚úé'; document.getElementById('edit-btn').classList.remove('active'); StorageManager.renderList(); }
            sb.classList.remove('active'); ov.classList.remove('active');
        }
    }
    function toggleEditMode() {
        isEditMode = !isEditMode;
        const btn = document.getElementById('edit-btn');
        if (isEditMode) { StorageManager.initTemp(); btn.innerHTML = 'üíæ'; btn.classList.add('active'); }
        else { StorageManager.commit(); btn.innerHTML = '‚úé'; btn.classList.remove('active'); }
        StorageManager.renderList();
    }
    function onSavedItemClick(id) { isEditMode ? StorageManager.renameItem(id) : loadSavedItem(id); }
    function deleteSaved(e, id) { e.stopPropagation(); if(confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÂóéÔºü')) StorageManager.deleteItem(id); }
    
    function saveCurrentAsGroup() {
        const cards = document.querySelectorAll('.card');
        if (cards.length === 0) return alert('ÁõÆÂâçÊ≤íÊúâ‰ªª‰ΩïÂç°ÁâáÂèØÂÑ≤Â≠ò');
        
        let defName;
        const firstCard = window.cardRegistry[cards[0].id];
        if (firstCard instanceof MTRLineCard) {
            defName = `Ê∏ØÈêµ ${firstCard.lineInfo.lineName}`;
        } else if (firstCard instanceof MTRStationCard) {
            defName = `Ê∏ØÈêµ ${firstCard.stationInfo.staName}`;
        } else {
            defName = `${firstCard.company} ${firstCard.route}` + (firstCard.currentDestName ? ` ÂæÄ ${firstCard.currentDestName}` : '');
        }
        if (cards.length > 1) defName = 'ÊàëÁöÑÈÄöÂã§ÁµÑÂêà';
        
        const name = prompt('Ë´ãËº∏ÂÖ•ÂêçÁ®±Ôºö', defName);
        if (name) {
            const data = Array.from(cards).map(c => {
                const o = window.cardRegistry[c.id];
                if (!o) return null;
                if (o instanceof MTRStationCard) {
                    return { type: 'MTR', lineCode: o.lineCode, staCode: o.staCode };
                } else if (o instanceof MTRLineCard) {
                    return { type: 'MTR_LINE', lineCode: o.lineCode, dir: o.dir, markedSeq: o.markedSeq, filteredSeq: o.filteredSeq };
                } else { // BusRouteCard
                    return { type: 'BUS', route: o.route, dir: o.dir, co: o.company, destName: o.currentDestName, filteredSeq: o.filteredSeq, markedSeq: o.markedSeq };
                }
            }).filter(x=>x);
            StorageManager.saveItem(name, data);
        }
    }
    function loadSavedItem(id) {
        const item = StorageManager.getList().find(x => x.id === id);
        if (!item) return;
        clearAllCards(false);
        item.data.forEach(d => {
            if (d.type === 'MTR') {
                createMtrCard(d.lineCode, d.staCode, d);
            } else if (d.type === 'MTR_LINE') {
                createMtrLineCard(d.lineCode, d);
            } else { // 'BUS' or legacy
                createCard(d.route, d.co || 'KMB', d);
            }
        });
        toggleSidebar(false);
    }
    function clearAllCards(showEmpty = true) {
        document.getElementById('cards-container').innerHTML = showEmpty ? '<div id="empty-state"><div class="big-icon">üöç</div><div>Ë´ãËº∏ÂÖ•Ë∑ØÁ∑öËôüÁ¢ºÊàñÊ∏ØÈêµÁ∂´ÈñãÂßãÊü•Ë©¢</div></div>' : '';
        window.cardRegistry = {};
        document.getElementById('add-card-section').style.display = 'none';
    }

    // --- Input & Search ---
    function toggleAddSearch(show) {
        document.getElementById('show-add-btn').style.display = show ? 'none' : 'flex';
        const wrapper = document.getElementById('add-search-wrapper');
        wrapper.classList.toggle('active', show);
        if(show) document.getElementById('add-route-input').focus();
    }
    function handleInput(input, listId, clearId) {
        const val = input.value.trim();
        const upperVal = val.toUpperCase();
        document.getElementById(clearId).style.display = val.length ? 'flex' : 'none';
        const list = document.getElementById(listId);
        if (!val) {
            list.classList.remove('show');
            return;
        }
        
        const busMatches = allRoutesDB.filter(r => r.route.startsWith(upperVal)).slice(0, 8);
        const mtrLineMatches = allMtrLines.filter(l => l.lineName.includes(val) || l.lineCode.startsWith(upperVal)).slice(0, 5);
        
        const getBadgeClass = co => ({'KMB':'badge-kmb', 'CTB':'badge-ctb', 'NLB':'badge-nlb', 'MTR': 'badge-mtr'}[co]);
        const getBadgeText = co => ({'KMB':'‰πùÂ∑¥', 'CTB':'ÂüéÂ∑¥', 'NLB':'Â∂ºÂ∑¥', 'MTR':'Ê∏ØÈêµ'}[co]);

        const mtrLineHtml = mtrLineMatches.map(l => `
            <div class="suggestion-item" onmousedown="selectSuggestion({type: 'MTR_LINE', lineCode: '${l.lineCode}', inputId: '${input.id}', listId: '${listId}'})">
                 <div class="sug-left"><span class="co-badge ${getBadgeClass('MTR')}">${getBadgeText('MTR')}</span><span class="sug-route">${l.lineName}</span></div>
                <span class="sug-desc">È°ØÁ§∫Êï¥Ê¢ùË∑ØÁ∂´</span>
            </div>`).join('');
            
        const busHtml = busMatches.map(r => `
            <div class="suggestion-item" onmousedown="selectSuggestion({type: 'BUS', route: '${r.route}', co: '${r.co}', inputId: '${input.id}', listId: '${listId}'})">
                <div class="sug-left"><span class="co-badge ${getBadgeClass(r.co)}">${getBadgeText(r.co)}</span><span class="sug-route">${r.route}</span></div>
                <span class="sug-desc">${r.orig} ‚áÑ ${r.dest}</span>
            </div>`).join('');

        list.innerHTML = mtrLineHtml + busHtml;
        list.classList.toggle('show', list.innerHTML.length > 0);
    }
    function clearSearch(id) {
        const el = document.getElementById(id); el.value = ''; el.focus();
        document.getElementById(id==='route-input'?'clear-search':'add-clear-search').style.display='none';
    }
    function selectSuggestion(params) {
        const { type, inputId, listId } = params;
        const inputEl = document.getElementById(inputId);
        
        document.getElementById(listId).classList.remove('show');
        
        const actionMap = {
            'BUS': () => createCard(params.route, params.co),
            'MTR': () => createMtrCard(params.lineCode, params.staCode),
            'MTR_LINE': () => createMtrLineCard(params.lineCode)
        };

        if (inputId === 'route-input') {
            clearAllCards(false);
            actionMap[type]();
        } else {
            actionMap[type]();
            toggleAddSearch(false);
        }
        inputEl.value = '';
    }

    function triggerShake(id) { const el = document.getElementById(id); el.classList.add('shake'); setTimeout(() => el.classList.remove('shake'), 400); el.focus(); }
    
    function searchTopItem() { 
        const input = document.getElementById('route-input');
        if (!input.value) return triggerShake('route-input');
        alert('Ë´ãÂæûÂª∫Ë≠∞ÂàóË°®‰∏≠ÈÅ∏Êìá‰∏ÄÂÄãÈ†ÖÁõÆ„ÄÇ');
    }
    function addItem() {
         const input = document.getElementById('add-route-input');
         if (!input.value) return triggerShake('add-route-input');
         alert('Ë´ãÂæûÂª∫Ë≠∞ÂàóË°®‰∏≠ÈÅ∏Êìá‰∏ÄÂÄãÈ†ÖÁõÆ„ÄÇ');
    }
    
    function createCard(route, company, saved = null) {
        const id = `card-${++cardCounter}`;
        const card = new BusRouteCard(route, id, saved, company);
        window.cardRegistry[id] = card;
        card.init();
        document.getElementById('add-card-section').style.display = 'flex';
    }

    function createMtrCard(lineCode, staCode, saved = null) {
        const id = `card-${++cardCounter}`;
        const card = new MTRStationCard(lineCode, staCode, id, saved);
        window.cardRegistry[id] = card;
        card.init();
        document.getElementById('add-card-section').style.display = 'flex';
    }

    function createMtrLineCard(lineCode, saved = null) {
        const id = `card-${++cardCounter}`;
        const card = new MTRLineCard(lineCode, id, saved);
        window.cardRegistry[id] = card;
        card.init();
        document.getElementById('add-card-section').style.display = 'flex';
    }

    // --- Base Card Class for common methods ---
    class BaseCard {
        destroy() {
            clearInterval(this.timer);
            this.element.style.cssText = 'opacity:0; transform:scale(0.9); margin-bottom:0; max-height:0;';
            setTimeout(() => {
                this.element.remove();
                delete window.cardRegistry[this.id];
                if(Object.keys(window.cardRegistry).length===0) clearAllCards(true);
            }, 300);
        }
    }


    // --- Class: MTR Station Card ---
    class MTRStationCard extends BaseCard {
        constructor(lineCode, staCode, id, saved) {
            super();
            this.id = id;
            this.lineCode = lineCode;
            this.staCode = staCode;
            this.stationInfo = allMtrStations.find(s => s.lineCode === lineCode && s.staCode === staCode);
            this.element = null;
            this.timer = null;
        }
        
        init() {
            document.getElementById('empty-state')?.remove();
            const div = document.createElement('div');
            div.className = 'card mtr-card';
            div.id = this.id; div.setAttribute('draggable', 'true');
            div.innerHTML = `
                <div class="card-header">
                    <div class="drag-handle">‚â°</div><div class="close-card-btn" onclick="window.cardRegistry['${this.id}'].destroy()">‚úï</div>
                    <div class="header-top">
                        <div style="display:flex;align-items:center;">
                            <span class="icon">üöá</span>
                            <span class="card-title">${this.stationInfo.staName} <small>(${this.stationInfo.lineName})</small></span>
                        </div>
                        <div style="font-size:0.8rem;opacity:0.8" class="update-time"></div>
                    </div>
                </div>
                <div class="card-content"><div class="status-msg">Ê≠£Âú®Áç≤ÂèñÂàóËªäË≥áÊñô...</div></div>`;
            document.getElementById('cards-container').appendChild(div);
            this.element = div;
            setTimeout(() => div.scrollIntoView({behavior:'smooth', block:'start'}), 100);
            
            div.addEventListener('dragstart', () => div.classList.add('dragging'));
            div.addEventListener('dragend', () => div.classList.remove('dragging'));

            this.fetchData();
            this.timer = setInterval(() => this.fetchData(), 30000);
        }

        renderError(message) {
            this.element.querySelector('.card-content').innerHTML = `<div class="status-msg error">${message}</div>`;
        }
        
        async fetchData() {
            this.element.querySelector('.update-time').innerText = 'Êõ¥Êñ∞‰∏≠...';
            try {
                const response = await fetch(`${MTR_API}?line=${this.lineCode}&sta=${this.staCode}&lang=TC`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                if (data.status === 0) {
                    this.renderError(data.message || 'ÊúçÂãôÁèæÊ≠£Êö´ÂÅú');
                    return;
                }

                const schedule = data.data[`${this.lineCode}-${this.staCode}`];
                this.render(schedule);
                this.element.querySelector('.update-time').innerText = 'Êõ¥Êñ∞Êñº ' + new Date().toLocaleTimeString('zh-HK', {hour:'2-digit', minute:'2-digit'});

            } catch (e) {
                this.renderError('Ë≥áÊñôËºâÂÖ•Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
                console.error(`MTR fetch failed for ${this.lineCode}-${this.staCode}:`, e);
            }
        }

        toggleTime(el) {
            const timeSpan = el.querySelector('.eta-minutes');
            if (!timeSpan) return;
            const isMinView = timeSpan.innerText === timeSpan.dataset.min;
            timeSpan.innerText = isMinView ? timeSpan.dataset.time : timeSpan.dataset.min;
            timeSpan.classList.toggle('show-real-time', isMinView);
        }
        
        _formatTrains(trains) {
            if (!trains || trains.length === 0) return '';
            return trains.map(train => {
                const destName = mtrStationNames[train.dest] || train.dest;
                const arrivalTime = new Date(train.time);
                const diffMins = Math.round((arrivalTime - new Date()) / 60000);
                
                // Filter ridiculous times
                if (diffMins > 120 || diffMins < -5) return '';

                const minStr = diffMins <= 0 ? 'Âç≥Â∞á' : `${diffMins}ÂàÜ`;
                const timeStr = arrivalTime.toLocaleTimeString('zh-HK', { hour: '2-digit', minute: '2-digit' });
                const platCircled = ['‚ì™','‚ë†','‚ë°','‚ë¢','‚ë£','‚ë§','‚ë•','‚ë¶','‚ëß','‚ë®','‚ë©'][parseInt(train.plat)] || `(${train.plat})`;

                return `
                    <div class="mtr-compact-eta" onclick="window.cardRegistry['${this.id}'].toggleTime(this)">
                        <span class="eta-minutes ${diffMins <= 1 ? 'urgent' : ''}" data-min="${minStr}" data-time="${timeStr}">${minStr}</span>
                        <span class="mtr-eta-details">${platCircled} ${destName}</span>
                    </div>`;
            }).join('');
        }

        render(data) {
            const contentEl = this.element.querySelector('.card-content');
            if (!data || (!data.UP && !data.DOWN)) {
                this.renderError('Êö´ÁÑ°Áè≠Ê¨°Ë≥áÊñô');
                return;
            }
            const upHtml = this._formatTrains(data.UP);
            const downHtml = this._formatTrains(data.DOWN);

            let finalHtml = '';
            if (upHtml) finalHtml += `<div class="mtr-direction-group">${upHtml}</div>`;
            if (downHtml) finalHtml += `<div class="mtr-direction-group">${downHtml}</div>`;
            
            if (!finalHtml) this.renderError('Êö´ÁÑ°Áè≠Ê¨°Ë≥áÊñô');
            else contentEl.innerHTML = finalHtml;
        }
    }

    // --- Class: MTR Line Card ---
    class MTRLineCard extends BaseCard {
        constructor(lineCode, id, saved) {
            super();
            this.id = id;
            this.lineCode = lineCode;
            this.lineInfo = allMtrLines.find(l => l.lineCode === lineCode);
            this.dir = saved ? saved.dir : 'UP';
            this.markedSeq = saved ? saved.markedSeq : null; 
            this.filteredSeq = saved ? saved.filteredSeq : null;
            this.element = null;
            this.timer = null;
        }

        init() {
            document.getElementById('empty-state')?.remove();
            const div = document.createElement('div');
            div.className = 'card mtr-card';
            div.id = this.id; div.setAttribute('draggable', 'true');
            
            const terminals = LINE_TERMINALS[this.lineCode];
            
            div.innerHTML = `
                <div class="card-header">
                    <div class="drag-handle">‚â°</div><div class="close-card-btn" onclick="window.cardRegistry['${this.id}'].destroy()">‚úï</div>
                    <div class="header-top">
                        <div style="display:flex;align-items:center;">
                            <span class="icon">üöá</span>
                            <span class="card-title">${this.lineInfo.lineName}</span>
                        </div>
                        <div style="font-size:0.8rem;opacity:0.8" class="update-time"></div>
                    </div>
                    <div class="direction-switch">
                        <span class="dir-opt btn-up" onclick="window.cardRegistry['${this.id}'].switchDir('UP')">ÂæÄ ${terminals.UP}</span>
                        <span class="dir-opt btn-down" onclick="window.cardRegistry['${this.id}'].switchDir('DOWN')">ÂæÄ ${terminals.DOWN}</span>
                    </div>
                </div>
                <div class="card-content"><div class="status-msg">Ê≠£Âú®Áç≤ÂèñÊï¥Ê¢ùÁ∂´ÂàóËªäË≥áÊñô...</div></div>`;
            document.getElementById('cards-container').appendChild(div);
            this.element = div;
            
            div.addEventListener('dragstart', () => div.classList.add('dragging'));
            div.addEventListener('dragend', () => div.classList.remove('dragging'));
            
            this.updateUI();
            this.fetchData();
            this.timer = setInterval(() => this.fetchData(), 30000);
            setTimeout(() => div.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
        }

        switchDir(dir) {
            if (this.dir === dir) return;
            this.dir = dir;
            // Clear filtering when switching direction to show full line
            this.filteredSeq = null; 
            this.markedSeq = null;
            this.updateUI();
            this.fetchData();
        }

        updateUI() {
            this.element.querySelector('.btn-up').classList.toggle('active', this.dir === 'UP');
            this.element.querySelector('.btn-down').classList.toggle('active', this.dir === 'DOWN');
        }

        renderError(message) {
            this.element.querySelector('.card-content').innerHTML = `<div class="status-msg error">${message}</div>`;
        }
        
        // This function handles the "row" click to toggle time
        toggleMode(el) {
            const isTime = el.classList.toggle('mode-time');
            el.querySelectorAll('.eta-minutes').forEach(s => { 
                s.innerText = s.dataset[isTime ? 'time' : 'min']; 
                s.classList.toggle('show-real-time', isTime);
            });
        }

        pin(e, staCode) {
            e.stopPropagation();
            if (this.filteredSeq === staCode) {
                this.filteredSeq = null; this.markedSeq = null;
            } else if (this.markedSeq === staCode) {
                this.filteredSeq = staCode;
            } else {
                this.markedSeq = staCode; this.filteredSeq = null;
            }
            this.applyVisual();
        }

        applyVisual() {
            this.element.querySelectorAll('.schedule-item').forEach(el => {
                const staCode = el.dataset.stacode;
                const span = el.querySelector('.dest-seq');
                const serial = el.dataset.serial;

                el.classList.toggle('hidden-row', this.filteredSeq !== null && this.filteredSeq !== staCode);
                el.classList.toggle('no-border', this.filteredSeq === staCode);

                if (this.markedSeq === staCode) {
                    span.innerHTML = '<span class="pin-icon">üìå</span>';
                    span.style.opacity = '1';
                } else {
                    span.innerHTML = serial;
                    span.style.opacity = '';
                }
            });
            
            if (this.filteredSeq) {
                const targetEl = this.element.querySelector(`.schedule-item[data-stacode="${this.filteredSeq}"]`);
                if (targetEl) targetEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        async fetchData() {
            this.element.querySelector('.update-time').innerText = 'Êõ¥Êñ∞‰∏≠...';
            // Use the strictly ordered station list
            const stationList = this.lineInfo.orderedStations;

            try {
                const responses = await Promise.all(
                    stationList.map(s => fetch(`${MTR_API}?line=${this.lineCode}&sta=${s.c}&lang=TC`).then(res => res.json()))
                );
                const allData = responses.map((data, i) => ({
                    staCode: stationList[i].c,
                    schedule: data.data ? data.data[`${this.lineCode}-${stationList[i].c}`] : null,
                }));
                
                this.render(allData);
                this.element.querySelector('.update-time').innerText = 'Êõ¥Êñ∞Êñº ' + new Date().toLocaleTimeString('zh-HK', {hour:'2-digit', minute:'2-digit'});

            } catch (e) {
                this.renderError('ÂÖ®Á∂´Ë≥áÊñôËºâÂÖ•Â§±Êïó');
                console.error(`MTR Line fetch failed for ${this.lineCode}:`, e);
            }
        }

        render(data) {
            const contentEl = this.element.querySelector('.card-content');
            let finalHtml = '';
            
            // For DOWN direction, reverse the data array to show from terminal to start
            if (this.dir === 'DOWN') {
                data.reverse();
            }
            
            // Build HTML with Serial Numbers
            let serial = 1;
            for (const stationData of data) {
                const { staCode, schedule } = stationData;
                let trainHtml = '';

                // Only process trains if schedule exists and is valid
                if (schedule) {
                    const trains = schedule[this.dir] || [];
                    trainHtml = trains.map(train => {
                        if (this.lineCode === 'EAL' && this.dir === 'UP' && !['LOW', 'LMC', 'SHT', 'TAP', 'FAN', 'SHS'].includes(train.dest)) return '';
                        if (this.lineCode === 'TKL' && this.dir === 'UP' && !['POA', 'LHP'].includes(train.dest)) return '';
                        
                        const destName = mtrStationNames[train.dest] || train.dest;
                        const arrivalTime = new Date(train.time);
                        const diffMins = Math.round((arrivalTime - new Date()) / 60000);
                        
                        // Filter Logic: Ghost trains (>120 mins) or passed trains (< -5 mins)
                        if (diffMins > 120 || diffMins < -5) return '';

                        const minStr = diffMins <= 0 ? 'Âç≥Â∞á' : `${diffMins}ÂàÜ`;
                        const timeStr = arrivalTime.toLocaleTimeString('zh-HK', { hour: '2-digit', minute: '2-digit' });
                        const platCircled = ['‚ì™','‚ë†','‚ë°','‚ë¢','‚ë£','‚ë§','‚ë•','‚ë¶','‚ëß','‚ë®','‚ë©'][parseInt(train.plat)] || `(${train.plat})`;

                        return `
                            <div class="mtr-compact-eta">
                                <span class="eta-minutes ${diffMins <= 1 ? 'urgent' : ''}" data-min="${minStr}" data-time="${timeStr}">${minStr}</span>
                                <span class="mtr-eta-details">${platCircled} ${destName}</span>
                            </div>`;
                    }).join('');
                }

                // If no valid train info, show "No Schedule" text but KEEP ROW
                if (!trainHtml.trim()) {
                    trainHtml = '<span class="no-schedule">Êö´ÁÑ°Áè≠Ê¨°</span>';
                }

                finalHtml += `
                    <div class="schedule-item" data-stacode="${staCode}" data-serial="${serial}" onclick="window.cardRegistry['${this.id}'].toggleMode(this)">
                        <div class="stop-info">
                            <span class="dest-seq" onclick="window.cardRegistry['${this.id}'].pin(event, '${staCode}')">${serial}</span>
                            <span class="dest-name">${mtrStationNames[staCode]}</span>
                        </div>
                        <div class="eta-container">${trainHtml}</div>
                    </div>`;
                serial++;
            }
            
            contentEl.innerHTML = finalHtml;
            this.applyVisual();
        }
    }


    // --- Class: Bus Route Card ---
    class BusRouteCard extends BaseCard {
        constructor(route, id, saved, company) {
            super();
            this.id = id; this.route = route; this.company = (saved ? saved.co : company) || company;
            this.dir = saved ? saved.dir : 'outbound';
            this.markedSeq = saved ? saved.markedSeq : null; 
            this.filteredSeq = saved ? saved.filteredSeq : null;
            this.currentDestName = saved ? saved.destName : '';
            this.element = null; this.timer = null; this.currentStops = [];
            this.nlbIds = {};
            this.lastRenderedDir = null;
        }
        
        init() {
            document.getElementById('empty-state')?.remove();
            let cardClass = '', coName = '‰πùÂ∑¥';
            if (this.company === 'CTB') { cardClass = 'ctb-card'; coName = 'ÂüéÂ∑¥'; }
            else if (this.company === 'NLB') { cardClass = 'nlb-card'; coName = 'Â∂ºÂ∑¥'; }

            const div = document.createElement('div');
            div.className = `card ${cardClass}`;
            div.id = this.id; div.setAttribute('draggable', 'true');
            div.innerHTML = `
                <div class="card-header">
                    <div class="drag-handle">‚â°</div><div class="close-card-btn" onclick="window.cardRegistry['${this.id}'].destroy()">‚úï</div>
                    <div class="header-top"><div style="display:flex;align-items:center;"><span class="icon">üöå</span><span class="card-title">${coName} ${this.route}</span></div><div style="font-size:0.8rem;opacity:0.8" class="update-time"></div></div>
                    <div class="direction-switch"><span class="dir-opt btn-out" onclick="window.cardRegistry['${this.id}'].switchDir('outbound')">ÂæÄ ...</span><span class="dir-opt btn-in" onclick="window.cardRegistry['${this.id}'].switchDir('inbound')">ÂæÄ ...</span></div>
                </div>
                <div class="card-content"><div class="status-msg">Ê≠£Âú®ÂàÜÊûêË∑ØÁ∑öË≥áÊñô...</div></div>`;
            document.getElementById('cards-container').appendChild(div);
            this.element = div;
            setTimeout(() => div.scrollIntoView({behavior:'smooth', block:'start'}), 100);
            
            div.addEventListener('dragstart', () => div.classList.add('dragging'));
            div.addEventListener('dragend', () => div.classList.remove('dragging'));

            this.updateUI();
            this.fetchBoundaries().then(() => { this.fetchData(); this.timer = setInterval(() => this.fetchData(), 30000); });
        }

        async fetchBoundaries() {
            let outStops = [], inStops = [], outName = '', inName = '';

            if (this.company === 'NLB') {
                const variants = nlbRouteMap[this.route] || [];
                const processNLB = async (variant, dirKey) => {
                    if (!variant) return [];
                    this.nlbIds[dirKey] = variant.routeId;
                    try {
                        const data = await fetch(`${NLB_API}/stop.php?action=list&routeId=${variant.routeId}`).then(r=>r.json());
                        const stops = data.stops || [];
                        stops.forEach(s => stopCache[`NLB_${s.stopId}`] = s.stopName_c);
                        return stops.map((s, i) => ({ stop: s.stopId, seq: i+1, name: s.stopName_c }));
                    } catch { return []; }
                };
                [outStops, inStops] = await Promise.all([processNLB(variants[0], 'outbound'), processNLB(variants[1], 'inbound')]);
                outName = variants[0] ? variants[0].routeName_c.split('>')[1]?.trim() || variants[0].routeName_c : '';
                inName = variants[1] ? variants[1].routeName_c.split('>')[1]?.trim() || variants[1].routeName_c : '';
            } 
            else {
                const api = this.company === 'KMB' ? KMB_API : CTB_API;
                const getStops = async (d) => { try { return (await (await fetch(`${api}/route-stop/${this.company==='KMB'?'': 'CTB/'}${this.route}/${d}${this.company==='KMB'?'/1':''}`)).json()).data; } catch{ return []; } };
                [outStops, inStops] = await Promise.all([getStops('outbound'), getStops('inbound')]);
                const getName = async (list) => list.length ? await getStopName(list[list.length-1].stop, this.company) : '';
                [outName, inName] = await Promise.all([getName(outStops), getName(inStops)]);
            }

            this.element.querySelector('.btn-out').innerText = outStops.length ? `ÂæÄ ${outName || 'ÂéªÁ®ã'}` : 'ÂéªÁ®ã (ÁÑ°Ë≥áÊñô)';
            this.element.querySelector('.btn-in').innerText = inStops.length ? `ÂæÄ ${inName || 'ÂõûÁ®ã'}` : 'ÂõûÁ®ã (ÁÑ°Ë≥áÊñô)';
            this.element.querySelector('.btn-in').style.display = inStops.length ? 'block' : 'none';
            if(!inStops.length && outStops.length) this.element.querySelector('.btn-out').innerText += ' (Âæ™Áí∞Á∑ö)';

            this.destMap = { outbound: outName || 'ÂéªÁ®ã', inbound: inName || 'ÂõûÁ®ã' };
            this.currentDestName = this.destMap[this.dir];
            this.stopLists = { outbound: outStops, inbound: inStops };
        }

        switchDir(dir) {
            if(this.dir === dir) return;
            this.dir = dir; this.markedSeq = null; this.filteredSeq = null;
            this.currentDestName = this.destMap[dir];
            this.updateUI(); this.fetchData();
        }
        
        updateUI() {
            this.element.querySelector('.btn-out').classList.toggle('active', this.dir === 'outbound');
            this.element.querySelector('.btn-in').classList.toggle('active', this.dir === 'inbound');
        }

        async fetchData() {
            const listEl = this.element.querySelector('.card-content');
            this.element.querySelector('.update-time').innerText = 'Êõ¥Êñ∞‰∏≠...';
            if(listEl.innerText.includes('Êö´ÁÑ°')) listEl.classList.add('fading');
            
            try {
                this.currentStops = this.stopLists?.[this.dir];
                if (!this.currentStops?.length) await this.fetchBoundaries();
                this.currentStops = this.stopLists?.[this.dir];
                if (!this.currentStops?.length) { listEl.innerHTML = '<div class="status-msg">Ê≠§ÊñπÂêëÁÑ°ËªäÁ´ôË≥áÊñô</div>'; return listEl.classList.remove('fading'); }
                
                const needsRender = this.dir !== this.lastRenderedDir || !this.element.querySelector('.schedule-item');
                let rows = [];

                if (this.company === 'NLB') {
                    if (needsRender) {
                        this.render(this.currentStops.map(s => ({ seq: s.seq, name: s.name, etas: [] })));
                        this.lastRenderedDir = this.dir;
                    }
                    const routeId = this.nlbIds[this.dir];
                    this.currentStops.forEach(s => {
                         fetch(`${NLB_API}/stop.php?action=estimatedArrivals&routeId=${routeId}&stopId=${s.stop}&language=zh`)
                            .then(r => r.json()).then(data => this.updateRow(s.seq, (data.estimatedArrivals || []).map(e => ({ eta: e.estimatedArrivalTime })).sort((a,b)=>new Date(a.eta)-new Date(b.eta))))
                            .catch(() => this.updateRow(s.seq, null));
                    });
                } else {
                    if (this.company === 'KMB') {
                        const allEtas = (await (await fetch(`${KMB_API}/route-eta/${this.route}/1`)).json()).data || [];
                        const dirCode = this.dir === 'outbound' ? 'O' : 'I';
                        rows = await Promise.all(this.currentStops.map(async s => ({
                            seq: parseInt(s.seq), name: await getStopName(s.stop, 'KMB'),
                            etas: allEtas.filter(e => e.seq === parseInt(s.seq) && e.dir === dirCode && e.eta).sort((a,b)=>new Date(a.eta)-new Date(b.eta))
                        })));
                    } else { // CTB
                        rows = await Promise.all(this.currentStops.map(async s => {
                            const data = (await (await fetch(`${CTB_API}/eta/CTB/${s.stop}/${this.route}`)).json()).data || [];
                            return { seq: parseInt(s.seq), name: await getStopName(s.stop, 'CTB'), etas: data.filter(e => e.dir === (this.dir === 'outbound' ? 'O' : 'I') && e.eta).sort((a,b)=>new Date(a.eta)-new Date(b.eta)) };
                        }));
                    }
                    this.render(rows);
                    this.lastRenderedDir = this.dir;
                }
                
                this.element.querySelector('.update-time').innerText = 'Êõ¥Êñ∞Êñº ' + new Date().toLocaleTimeString('zh-HK', {hour:'2-digit', minute:'2-digit'});
            } catch (e) { listEl.innerHTML = '<div class="status-msg error">Ë≥áÊñôËºâÂÖ•Â§±Êïó</div>'; console.error(e); }
            listEl.classList.remove('fading');
        }
        
        generateTimeHtml(etas) {
            if (!etas || !etas.length) return '<span style="color:var(--text-sub);font-size:0.85rem;">Êö´ÁÑ°Áè≠Ê¨°</span>';
            return etas.slice(0,3).map(e => {
                const diff = Math.floor((new Date(e.eta) - new Date())/60000);
                const minStr = diff <= 0 ? 'Âç≥Â∞á' : diff+'ÂàÜ';
                const timeStr = new Date(e.eta).toLocaleTimeString('zh-HK', { hour: '2-digit', minute: '2-digit' });
                return `<span class="eta-minutes ${diff <= 1 ? 'urgent' : ''}" data-min="${minStr}" data-time="${timeStr}" style="margin-left:4px;">${minStr}</span>`;
            }).join('');
        }

        render(rows) {
            const el = this.element.querySelector('.card-content');
            if(!rows.length) { el.innerHTML = '<div class="status-msg">Êö´ÁÑ°Ë≥áÊñô</div>'; return; }
            el.innerHTML = rows.sort((a,b)=>a.seq-b.seq).map(r => `
                <div class="schedule-item" data-seq="${r.seq}" onclick="window.cardRegistry['${this.id}'].toggleMode(this)">
                    <div class="stop-info"><span class="dest-seq" onclick="window.cardRegistry['${this.id}'].pin(event,${r.seq})">${r.seq}</span><span class="dest-name">${r.name}</span></div>
                    <div class="eta-container">${this.generateTimeHtml(r.etas)}</div>
                </div>`).join('');
            this.applyVisual();
        }
        
        updateRow(seq, etas) {
            const container = this.element.querySelector(`.schedule-item[data-seq="${seq}"] .eta-container`);
            if (!container) return;
            container.innerHTML = this.generateTimeHtml(etas);
            if (container.parentElement.classList.contains('mode-time')) this.toggleMode(container.parentElement, true);
        }
        
        toggleMode(el, forceToMin = false) {
            const isTime = el.classList.contains('mode-time');
            if (forceToMin && !isTime) return; // Already in min mode
            if (forceToMin && isTime) {
                 el.classList.remove('mode-time');
            } else {
                 el.classList.toggle('mode-time');
            }
            const shouldBeTime = el.classList.contains('mode-time');

            el.querySelectorAll('.eta-minutes').forEach(s => { 
                s.innerText = s.dataset[shouldBeTime ? 'time' : 'min']; 
                s.classList.toggle('show-real-time', shouldBeTime); 
            });
        }

        pin(e, seq) { e.stopPropagation();
            if(this.filteredSeq === seq) { this.filteredSeq = null; this.markedSeq = null; }
            else if(this.markedSeq === seq) { this.filteredSeq = seq; }
            else { this.markedSeq = seq; this.filteredSeq = null; }
            this.applyVisual();
        }

        applyVisual() {
            this.element.querySelectorAll('.schedule-item').forEach(el => {
                const seq = parseInt(el.dataset.seq), span = el.querySelector('.dest-seq');
                el.classList.toggle('hidden-row', this.filteredSeq !== null && this.filteredSeq !== seq);
                el.classList.toggle('no-border', this.filteredSeq === seq);
                span.innerHTML = (this.markedSeq === seq) ? '<span class="pin-icon">üìå</span>' : seq;
            });
        }
    }

    // --- Helpers ---
    function getDragAfterElement(container, y, selector) {
        return [...container.querySelectorAll(`${selector}:not(.dragging)`)].reduce((closest, child) => {
            const offset = y - child.getBoundingClientRect().top - child.getBoundingClientRect().height / 2;
            return (offset < 0 && offset > closest.offset) ? { offset, element: child } : closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    async function preloadAllRoutes() {
        try {
            const [k, c, n] = await Promise.all([
                fetch(`${KMB_API}/route/`).then(r=>r.json()).catch(()=>({data:[]})),
                fetch(`${CTB_API}/route/CTB`).then(r=>r.json()).catch(()=>({data:[]})),
                fetch(`${NLB_API}/route.php?action=list`).then(r=>r.json()).catch(()=>({routes:[]}))
            ]);
            
            nlbRouteMap = (n.routes || []).reduce((acc, r) => {
                if(!acc[r.routeNo]) acc[r.routeNo] = [];
                acc[r.routeNo].push(r); return acc;
            }, {});

            const nlbList = Object.keys(nlbRouteMap).map(rNo => {
                const parts = nlbRouteMap[rNo][0].routeName_c.split('>');
                return { route: rNo, orig: parts[0]?.trim() || '?', dest: parts[1]?.trim() || '?', co: 'NLB' };
            });

            const seen = new Set();
            allRoutesDB = [...(k.data||[]).map(r=>({route:r.route,orig:r.orig_tc,dest:r.dest_tc,co:'KMB'})),
                           ...(c.data||[]).map(r=>({route:r.route,orig:r.orig_tc,dest:r.dest_tc,co:'CTB'})),
                           ...nlbList]
                .filter(r => seen.has(r.route+'_'+r.co) ? false : seen.add(r.route+'_'+r.co))
                .sort((a,b) => (parseInt(a.route.replace(/\D/g,''))||0) - (parseInt(b.route.replace(/\D/g,''))||0) || a.route.localeCompare(b.route));
        } catch (e) { console.error("Failed to preload routes", e); }
    }

    async function getStopName(id, co) {
        const key = `${co}_${id}`;
        if (stopCache[key]) return stopCache[key];
        try {
            const d = await (await fetch(`${co==='KMB'?KMB_API:CTB_API}/stop/${id}`)).json();
            return stopCache[key] = d.data.name_tc;
        } catch { return 'Êú™Áü•ËªäÁ´ô'; }
    }

    function toggleDarkMode() {
        const on = document.getElementById('dm-toggle').checked;
        document.body.classList.toggle('dark-mode', on);
        localStorage.setItem('darkMode', on ? 'enabled' : 'disabled');
    }
    function initDarkMode() {
        const m = localStorage.getItem('darkMode');
        if (m === 'enabled' || (!m && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.body.classList.add('dark-mode'); document.getElementById('dm-toggle').checked = true;
        }
    }
</script>
</body>
</html>
